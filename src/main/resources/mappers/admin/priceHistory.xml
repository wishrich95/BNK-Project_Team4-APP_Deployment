<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 비트코인 시세 -->
<mapper namespace="kr.co.busanbank.mapper.PriceHistoryMapper">

    <insert id="insertPrice">
        INSERT INTO PRICEHISTORY (SYMBOL, PRICE, CREATEDAT)
        SELECT #{symbol}, #{price}, SYSTIMESTAMP AT TIME ZONE 'Asia/Seoul'
        FROM dual
        WHERE NOT EXISTS (
        SELECT 1 FROM PRICEHISTORY
        WHERE SYMBOL = #{symbol}
        AND TRUNC(CREATEDAT, 'HH24') = TRUNC(SYSTIMESTAMP AT TIME ZONE 'Asia/Seoul', 'HH24')
        )
    </insert>


    <select id="getBtc" resultType="kr.co.busanbank.dto.PriceHistoryDTO">
        SELECT
        TRUNC(CREATEDAT) AS createdAt,
        AVG(PRICE) AS price
        FROM PRICEHISTORY
        WHERE SYMBOL = 'BTC'
        AND CREATEDAT >= SYSTIMESTAMP - INTERVAL '30' DAY
        GROUP BY TRUNC(CREATEDAT)
        ORDER BY TRUNC(CREATEDAT) ASC
    </select>
    <select id="getBtcYesterdayAndToday" resultType="kr.co.busanbank.dto.PriceHistoryDTO">
        SELECT
        TRUNC(CREATEDAT) AS createdAt,
        AVG(PRICE) AS price
        FROM PRICEHISTORY
        WHERE SYMBOL = 'BTC'
        AND TRUNC(CREATEDAT) >= TRUNC(SYSDATE) - 1
        GROUP BY TRUNC(CREATEDAT)
        ORDER BY TRUNC(CREATEDAT) ASC
    </select>

    <select id="getGold" resultType="kr.co.busanbank.dto.PriceHistoryDTO">
        SELECT
        ID,
        SYMBOL,
        PRICE,
        CREATEDAT
        FROM PRICEHISTORY
        WHERE SYMBOL = 'XAU'
        AND CREATEDAT >= SYSTIMESTAMP - INTERVAL '30' DAY
        ORDER BY CREATEDAT ASC
    </select>

    <select id="getOil" resultType="kr.co.busanbank.dto.PriceHistoryDTO">
        SELECT
        ID,
        SYMBOL,
        PRICE,
        CREATEDAT
        FROM PRICEHISTORY
        WHERE SYMBOL = 'OIL'
        AND CREATEDAT >= SYSTIMESTAMP - INTERVAL '30' DAY
        ORDER BY CREATEDAT ASC
    </select>

</mapper>