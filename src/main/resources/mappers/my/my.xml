<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.busanbank.mapper.MyMapper">
    <update id="updateInfo">
        UPDATE users
        SET email = #{email},
        hp = #{hp},
        zip = #{zip},
        addr1 = #{addr1},
        addr2 = #{addr2}
        WHERE userId = #{userId}
    </update>

    <select id="getUserById" resultType="kr.co.busanbank.dto.UsersDTO">
        select * from users where userId = #{userId}
    </select>

    <select id="getUserPwById" resultType="String">
        SELECT userPw
        FROM users
        WHERE userId = #{userId}
    </select>

    <select id="getUserAccountPwById" resultType="String">
        SELECT accountPassword
        FROM users
        WHERE userId = #{userId}
    </select>


    <update id="updatePw">
        UPDATE users
        SET userPw = #{userPw}
        WHERE userId = #{userId}
    </update>

    <delete id="deleteUser">
        DELETE FROM users
        WHERE userId = #{userId}
    </delete>

    <select id="countUserItems" resultType="int">
        SELECT NVL(count(*), 0)
        FROM userproduct
        WHERE userId = #{userId}
    </select>


    <select id="getProductLastDate" resultType="String">
        SELECT NVL(TO_CHAR(MIN(EXPECTEDENDDATE), 'YYYY-MM-DD'), '없음') AS lastDate
        FROM USERPRODUCT
        WHERE USERID = #{userId}
    </select>


    <select id="getProductRecentlyDate" resultType="String">
        SELECT NVL(
        (SELECT TO_CHAR(startdate, 'YYYY-MM-DD')
        FROM userproduct
        WHERE userId = #{userId}
        ORDER BY startdate DESC
        FETCH FIRST 1 ROWS ONLY), '없음') AS startdate
        FROM dual
    </select>

    <!-- 2025/12/30 - 계좌번호 조회 추가 - 작성자: 진원 -->
    <select id="getUserProducts" resultType="kr.co.busanbank.dto.UserProductDTO">
        SELECT a.userId AS userIdStr,
        a.productNo,
        a.startDate,
        a.status,
        a.endDate,
        a.applyRate,
        a.contractTerm,
        a.principalAmount,
        a.expectedEndDate,
        a.contractEarlyRate,
        a.createdAt,
        a.updatedAt,
        b.productName,
        b.productType,
        b.baseRate,
        b.maturityRate,
        b.earlyTerminateRate,
        b.monthlyAmount,
        b.savingTerm,
        b.depositAmount,
        b.interestMethod,
        b.payCycle,
        b.endDate,
        ua.accountNo AS accountNo
        FROM userproduct a
        JOIN product b ON a.productno = b.productno
        LEFT JOIN useraccount ua ON a.userid = ua.userid AND a.productno = ua.productno
        WHERE a.userid = #{userId}
        ORDER BY a.startDate DESC
    </select>

    <select id="getUserProductNames" resultType="kr.co.busanbank.dto.UserProductDTO">
        SELECT a.expectedEndDate, b.productname, b.productNo
        FROM userproduct a
        JOIN product b
        ON a.productno = b.productno
        WHERE a.userid = #{userId} and a.status='A'
    </select>

    <delete id="deleteProduct">
        DELETE FROM userproduct
        WHERE userId = #{userId} and productNo = #{productNo}
    </delete>

    <select id="getCancelProduct" resultType="kr.co.busanbank.dto.UserProductDTO">
        SELECT
        a.userId AS userIdStr,
        a.productNo,
        a.startDate,
        a.status,
        a.endDate,
        a.applyRate,
        a.contractTerm,
        a.principalAmount,
        a.expectedEndDate,
        a.contractEarlyRate,
        a.createdAt,
        a.updatedAt,
        b.productName,
        b.productType,
        b.baseRate,
        b.maturityRate,
        b.earlyTerminateRate,
        b.monthlyAmount,
        b.savingTerm,
        b.depositAmount,
        b.interestMethod,
        b.payCycle,
        b.endDate
        FROM userproduct a
        JOIN product b
        ON a.productno = b.productno
        WHERE a.userId = #{userId} AND b.productNo = #{productNo}
    </select>

    <select id="getUserNo" resultType="int">
        SELECT userNo FROM users WHERE userId = #{userId}
    </select>

    <select id="getEmailList" resultType="kr.co.busanbank.dto.EmailCounselDTO">
        SELECT * FROM emailcounsel WHERE userId = #{userNo} ORDER BY createdAt DESC fetch first 3 rows only
    </select>

    <select id="getUserAccountList" resultType="kr.co.busanbank.dto.UserAccountDTO">
        SELECT a.accountNo,
        b.balance,
        a.productno,
        d.productname,
        c.startdate,
        c.expectedenddate,
        c.applyrate
        FROM useraccount a
        JOIN account b ON a.accountno = b.accountno
        JOIN userproduct c ON a.productno = c.productno
        JOIN product d ON c.productno = d.productno
        WHERE c.userid = #{userNo} AND a.userid = #{userNo} and b.status = 'Y'
    </select>

    <select id="getUserBalance" resultType="int">
        SELECT sum(balance) from useraccount a
        join account b on a.accountno=b.accountno
        where a.userid=#{userNo}
    </select>

    <select id="getCancelProductData" resultType="kr.co.busanbank.dto.CancelProductDTO">
        SELECT
        up.PRODUCTNO,
        up.STARTDATE,
        up.expectedEndDate,
        up.PRINCIPALAMOUNT,
        up.APPLYRATE,
        up.CONTRACTEARLYRATE,
        up.CONTRACTTERM,
        p.PRODUCTNAME,
        a.ACCOUNTNO,
        up.contractterm
        FROM
        USERPRODUCT up
        JOIN
        PRODUCT p ON up.PRODUCTNO = p.PRODUCTNO
        JOIN
        USERACCOUNT ua ON up.USERID = ua.USERID AND up.PRODUCTNO = ua.PRODUCTNO
        JOIN
        ACCOUNT a ON ua.ACCOUNTNO = a.ACCOUNTNO
        WHERE
        up.USERID = #{userNo} AND up.productNo = #{productNo} and up.status = 'A'
    </select>

    <select id="getUserDepositAccounts" resultType="kr.co.busanbank.dto.UserAccountDTO">
        SELECT DISTINCT
        a.accountNo,
        c.productName
        FROM useraccount a
        JOIN account acc ON a.accountNo = acc.accountNo
        JOIN userproduct b ON a.userId = b.userId AND a.productNo = b.productNo
        JOIN product c ON a.productNo = c.productNo
        WHERE a.userId = #{userNo}
        AND c.categoryId = 3
        AND acc.status = 'Y'
    </select>

    <update id="depositToAccount">
        UPDATE account
        SET balance = balance + #{amount},
        UPDATEDAT = SYSDATE
        WHERE accountNo = #{accountNo}
    </update>

    <update id="terminateProduct">
        UPDATE userproduct
        SET status = 'N',
        enddate = SYSDATE
        WHERE userId = #{userId}
        AND productNo = #{productNo}
    </update>

    <update id="updateAccountStatusToN">
        UPDATE ACCOUNT
        SET STATUS = 'N',
        UPDATEDAT = SYSDATE
        WHERE ACCOUNTNO = #{accountNo}
    </update>

    <update id="updateUserStatusToW">
        UPDATE users
        SET status = 'W',
        updatedat = SYSDATE
        WHERE userId = #{userId}
    </update>


    <update id="updateUsersToD">
        UPDATE users
        SET status = 'S',
        updatedat = SYSDATE
        WHERE status = 'W'
        AND updatedat &lt;= SYSDATE - 7
    </update>

    <select id="findTotalUsedPoints">
        SELECT NVL((
        SELECT BALANCEAFTER
        FROM pointhistory
        WHERE USERID = #{userId}
        ORDER BY createdat DESC
        FETCH FIRST 1 ROWS ONLY
        ), 0) AS balance
        FROM dual
    </select>

    <update id="updateBalanceToZero">
        UPDATE ACCOUNT
        SET BALANCE = 0,
        UPDATEDAT = SYSDATE
        WHERE ACCOUNTNO = #{accountNo}
    </update>


</mapper>
