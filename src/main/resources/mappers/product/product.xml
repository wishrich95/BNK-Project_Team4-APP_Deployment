<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--
    작성자: 진원
    작성일: 2025-11-16
    설명: 금융상품 관리 Mapper (CRUD) - 수정본
-->
<mapper namespace="kr.co.busanbank.mapper.ProductMapper">

    <!-- 상품 목록 조회 (페이징) + 가입자 수 포함 (작성자: 진원, 2025-11-23) -->
    <select id="selectProductList" resultType="kr.co.busanbank.dto.ProductDTO">
        SELECT * FROM (
        SELECT
        p.PRODUCTNO as productNo,
        p.PRODUCTNAME as productName,
        p.PRODUCTTYPE as productType,
        p.CATEGORYID as categoryId,
        c.CATEGORYNAME as categoryName,
        p.DESCRIPTION as description,
        p.BASERATE as baseRate,
        p.MATURITYRATE as maturityRate,
        p.EARLYTERMINATERATE as earlyTerminateRate,
        p.MONTHLYAMOUNT as monthlyAmount,
        p.SAVINGTERM as savingTerm,
        p.DEPOSITAMOUNT as depositAmount,
        p.INTERESTMETHOD as interestMethod,
        p.PAYCYCLE as payCycle,
        TO_CHAR(p.ENDDATE, 'YYYY-MM-DD') as endDate,
        p.ADMINID as adminId,
        TO_CHAR(p.CREATEDAT, 'YYYY-MM-DD HH24:MI:SS') as createdAt,
        TO_CHAR(p.UPDATEDAT, 'YYYY-MM-DD HH24:MI:SS') as updatedAt,
        p.STATUS as status,
        p.HIT as hit,
        (SELECT COUNT(*) FROM USERPRODUCT up WHERE up.PRODUCTNO = p.PRODUCTNO AND up.STATUS = 'A') as subscriberCount,
        ROW_NUMBER() OVER (ORDER BY p.createdAt DESC) as rnum
        FROM PRODUCT p
        LEFT JOIN CATEGORY c ON p.CATEGORYID = c.CATEGORYID
        WHERE p.status = 'Y'
        <if test="searchKeyword != null and searchKeyword != ''">
            AND (
            p.productName LIKE '%' || #{searchKeyword} || '%'
            OR p.description LIKE '%' || #{searchKeyword} || '%'
            )
        </if>
        <if test="productType != null and productType != ''">
            AND p.productType = #{productType}
        </if>
        )
        WHERE rnum BETWEEN #{offset} + 1 AND #{offset} + #{limit}
    </select>

    <!-- 상품 전체 개수 -->
    <select id="countProducts" resultType="int">
        SELECT COUNT(*) FROM PRODUCT
        WHERE status = 'Y'
        <if test="searchKeyword != null and searchKeyword != ''">
            AND (
            productName LIKE '%' || #{searchKeyword} || '%'
            OR description LIKE '%' || #{searchKeyword} || '%'
            )
        </if>
        <if test="productType != null and productType != ''">
            AND productType = #{productType}
        </if>
    </select>

    <!-- 상품 ID로 조회 - ★★★ joinTypesStr 수진 ★★★ -->
    <select id="selectProductById" parameterType="int" resultType="kr.co.busanbank.dto.ProductDTO">
        SELECT
        p.PRODUCTNO as productNo,
        p.PRODUCTNAME as productName,
        p.PRODUCTTYPE as productType,
        p.CATEGORYID as categoryId,
        c.CATEGORYNAME as categoryName,
        p.DESCRIPTION as description,
        p.BASERATE as baseRate,
        p.MATURITYRATE as maturityRate,
        p.EARLYTERMINATERATE as earlyTerminateRate,
        p.MONTHLYAMOUNT as monthlyAmount,
        p.SAVINGTERM as savingTerm,
        p.DEPOSITAMOUNT as depositAmount,
        p.INTERESTMETHOD as interestMethod,
        p.PAYCYCLE as payCycle,
        TO_CHAR(p.ENDDATE, 'YYYY-MM-DD') as endDate,
        p.ADMINID as adminId,
        TO_CHAR(p.CREATEDAT, 'YYYY-MM-DD HH24:MI:SS') as createdAt,
        TO_CHAR(p.UPDATEDAT, 'YYYY-MM-DD HH24:MI:SS') as updatedAt,
        p.STATUS as status,
        p.HIT as hit,
        (SELECT LISTAGG(JOINTYPE, ',') WITHIN GROUP (ORDER BY JOINTYPE)
        FROM PRODUCTJOINTYPE
        WHERE PRODUCTNO = p.PRODUCTNO) AS joinTypesStr
        FROM PRODUCT p
        LEFT JOIN CATEGORY c ON p.CATEGORYID = c.CATEGORYID
        WHERE p.productNo = #{productNo}
    </select>

    <!-- 상품 추가 -->
    <insert id="insertProduct" parameterType="kr.co.busanbank.dto.ProductDTO">
        <selectKey keyProperty="productNo" order="BEFORE" resultType="int">
            SELECT NVL(MAX(productNo), 0) + 1 FROM PRODUCT
        </selectKey>
        INSERT INTO PRODUCT (
        productNo,
        productName,
        productType,
        categoryId,
        description,
        baseRate,
        maturityRate,
        earlyTerminateRate,
        monthlyAmount,
        savingTerm,
        depositAmount,
        interestMethod,
        payCycle,
        endDate,
        adminId,
        createdAt,
        updatedAt,
        status
        ) VALUES (
        #{productNo},
        #{productName},
        #{productType},
        #{categoryId},
        #{description},
        #{baseRate},
        #{maturityRate},
        #{earlyTerminateRate},
        #{monthlyAmount},
        #{savingTerm},
        #{depositAmount},
        #{interestMethod},
        #{payCycle},
        TO_DATE(#{endDate}, 'YYYY-MM-DD'),
        #{adminId},
        SYSDATE,
        SYSDATE,
        'Y'
        )
    </insert>

    <!-- 상품 가입 정보 INSERT -->
    <insert id="insertUserProduct" parameterType="kr.co.busanbank.dto.UserProductDTO">
        INSERT INTO USERPRODUCT (
        USERID,
        PRODUCTNO,
        STARTDATE,
        STATUS,
        CREATEDAT,
        UPDATEDAT,
        ENDDATE,
        APPLYRATE,
        CONTRACTTERM,
        PRINCIPALAMOUNT,
        EXPECTEDENDDATE,
        CONTRACTEARLYRATE,
        ACCOUNTPASSWORD,
        BRANCHID,
        EMPID,
        NOTIFICATION_SMS,
        NOTIFICATION_EMAIL,
        NOTIFICATION_HP,
        NOTIFICATION_EMAIL_
        ) VALUES (
        #{userId},
        #{productNo},
        TO_DATE(#{startDate}, 'YYYY-MM-DD'),
        #{status},
        SYSDATE,
        NULL,
        TO_DATE(#{expectedEndDate}, 'YYYY-MM-DD'),
        #{applyRate},
        #{contractTerm},
        #{principalAmount},
        TO_DATE(#{expectedEndDate}, 'YYYY-MM-DD'),
        #{contractEarlyRate},
        #{accountPassword},
        #{branchId},
        #{empId},
        #{notificationSms},
        #{notificationEmail},
        #{notificationHp},
        #{notificationEmailAddr}
        )
    </insert>


    <select id="selectContractEarlyRate" resultType="java.math.BigDecimal">
        SELECT EARLYTERMINATERATE
        FROM PRODUCT
        WHERE PRODUCTNO = #{productNo}
    </select>

    <!-- 상품 수정 -->
    <update id="updateProduct" parameterType="kr.co.busanbank.dto.ProductDTO">
        UPDATE PRODUCT
        SET
        productName = #{productName},
        productType = #{productType},
        categoryId = #{categoryId},
        description = #{description},
        baseRate = #{baseRate},
        maturityRate = #{maturityRate},
        earlyTerminateRate = #{earlyTerminateRate},
        monthlyAmount = #{monthlyAmount},
        savingTerm = #{savingTerm},
        depositAmount = #{depositAmount},
        interestMethod = #{interestMethod},
        payCycle = #{payCycle},
        <if test="endDate != null and endDate != ''">
            endDate = TO_DATE(#{endDate}, 'YYYY-MM-DD'),
        </if>
        updatedAt = SYSDATE
        WHERE productNo = #{productNo}
    </update>

    <!-- 상품 삭제 (soft delete) -->
    <update id="deleteProduct" parameterType="int">
        UPDATE PRODUCT
        SET status = 'N',
        updatedAt = SYSDATE
        WHERE productNo = #{productNo}
    </update>

    <!-- 상품명 중복 체크 -->
    <select id="countByProductName" parameterType="string" resultType="int">
        SELECT COUNT(*) FROM PRODUCT
        WHERE productName = #{productName}
        AND status = 'Y'
    </select>

    <!-- 카테고리별 상품 조회 + 가입타입로직 추가 -->
    <select id="selectProductsByCategory" resultType="kr.co.busanbank.dto.ProductDTO">
        SELECT
        p.PRODUCTNO as productNo,
        p.PRODUCTNAME as productName,
        p.PRODUCTTYPE as productType,
        p.CATEGORYID as categoryId,
        c.CATEGORYNAME as categoryName, <!-- 25.11.26_수빈 -->
        p.DESCRIPTION as description,
        p.BASERATE as baseRate,
        p.MATURITYRATE as maturityRate,
        p.EARLYTERMINATERATE as earlyTerminateRate,
        p.MONTHLYAMOUNT as monthlyAmount,
        p.SAVINGTERM as savingTerm,
        p.DEPOSITAMOUNT as depositAmount,
        p.INTERESTMETHOD as interestMethod,
        p.PAYCYCLE as payCycle,
        TO_CHAR(p.ENDDATE, 'YYYY-MM-DD') as endDate,
        p.ADMINID as adminId,
        TO_CHAR(p.CREATEDAT, 'YYYY-MM-DD HH24:MI:SS') as createdAt,
        TO_CHAR(p.UPDATEDAT, 'YYYY-MM-DD HH24:MI:SS') as updatedAt,
        p.STATUS as status,
        p.HIT as hit,

        (SELECT LISTAGG(JOINTYPE, ',') WITHIN GROUP (ORDER BY JOINTYPE)
        FROM PRODUCTJOINTYPE
        WHERE PRODUCTNO = p.PRODUCTNO) AS joinTypesStr

        <!-- 25.11.26_수빈 -->
        FROM PRODUCT p
        LEFT JOIN CATEGORY c ON p.CATEGORYID = c.CATEGORYID
        WHERE p.CATEGORYID = #{categoryId}
        AND p.STATUS = 'Y'
        ORDER BY p.PRODUCTNO
    </select>

    <select id="selectProductWithJoinTypes" resultType="kr.co.busanbank.dto.ProductDTO">
        SELECT p.productno, p.productname, p.producttype, p.categoryid, p.description,
        p.baserate, p.maturityrate, p.earlyterminaterate,
        p.monthlyamount, p.savingterm, p.depositamount,
        p.interestmethod, p.paycycle,
        p.enddate, p.adminid, p.createdat, p.updatedat, p.status, p.hit,
        (SELECT LISTAGG(JOINTYPE, ',') WITHIN GROUP (ORDER BY JOINTYPE)
        FROM PRODUCTJOINTYPE
        WHERE PRODUCTNO = p.PRODUCTNO) AS joinTypesStr
        FROM PRODUCT p
        WHERE p.productno = #{productNo}
    </select>

    <!-- 키워드 검색 -->
    <select id="searchProducts" parameterType="string" resultMap="productMap">
        SELECT *
        FROM PRODUCT
        WHERE STATUS = 'Y'
        AND (PRODUCTNAME LIKE '%' || #{keyword} || '%'
        OR DESCRIPTION LIKE '%' || #{keyword} || '%')
        ORDER BY PRODUCTNO DESC
    </select>

    <!-- searchProducts 키워드 조회용 쿼리 -->
    <resultMap id="productMap" type="kr.co.busanbank.dto.ProductDTO">
        <result property="productNo" column="PRODUCTNO"/>
        <result property="productName" column="PRODUCTNAME"/>
        <result property="productType" column="PRODUCTTYPE"/>
        <result property="categoryId" column="CATEGORYID"/>
        <result property="description" column="DESCRIPTION"/>

        <result property="baseRate" column="BASERATE"/>
        <result property="maturityRate" column="MATURITYRATE"/>
        <result property="earlyTerminateRate" column="EARLYTERMINATERATE"/>

        <result property="monthlyAmount" column="MONTHLYAMOUNT"/>
        <result property="savingTerm" column="SAVINGTERM"/>
        <result property="depositAmount" column="DEPOSITAMOUNT"/>

        <result property="interestMethod" column="INTERESTMETHOD"/>
        <result property="payCycle" column="PAYCYCLE"/>
        <result property="endDate" column="ENDDATE"/>
        <result property="adminId" column="ADMINID"/>

        <result property="createdAt" column="CREATEDAT"/>
        <result property="updatedAt" column="UPDATEDAT"/>
        <result property="status" column="STATUS"/>
        <result property="hit" column="HIT"/>
    </resultMap>

    <!-- 상품별 가입 유저 목록 조회 -->
    <select id="selectUsersByProductNo" resultType="kr.co.busanbank.dto.UserProductDTO">
        SELECT
            up.USERID as userId,
            u.USERNAME as userName,
            u.USERID as userIdStr,
            u.EMAIL as email,
            u.HP as hp,
            up.PRODUCTNO as productNo,
            p.PRODUCTNAME as productName,
            TO_CHAR(up.STARTDATE, 'YYYY-MM-DD') as startDate,
            up.STATUS as status,
            TO_CHAR(up.ENDDATE, 'YYYY-MM-DD') as endDate,
            up.APPLYRATE as applyRate,
            up.CONTRACTTERM as contractTerm,
            up.PRINCIPALAMOUNT as principalAmount,
            TO_CHAR(up.EXPECTEDENDDATE, 'YYYY-MM-DD') as expectedEndDate,
            up.CONTRACTEARLYRATE as contractEarlyRate,
            TO_CHAR(up.CREATEDAT, 'YYYY-MM-DD HH24:MI:SS') as createdAt,
            TO_CHAR(up.UPDATEDAT, 'YYYY-MM-DD HH24:MI:SS') as updatedAt
        FROM USERPRODUCT up
        LEFT JOIN USERS u ON up.USERID = u.USERID
        LEFT JOIN PRODUCT p ON up.PRODUCTNO = p.PRODUCTNO
        WHERE up.PRODUCTNO = #{productNo}
        ORDER BY up.CREATEDAT DESC
    </select>
     
    <!-- 상품 상세 정보 조회 -->
    <select id="getProductDetail" parameterType="int" resultType="kr.co.busanbank.dto.ProductDetailDTO">
        SELECT
        PRODUCTNO as productNo,
        ELIGIBILITY as eligibility,
        MINAMOUNT as minAmount,
        DEPOSITTYPE as depositType,
        PAYMENTMETHOD as paymentMethod,
        REQUIREDDOCS as requiredDocs,
        TAXBENEFIT as taxBenefit,
        PAYMENTLIMIT as paymentLimit,
        INTERESTPAYMENT as interestPayment,
        PREMIUMRATEINFO as premiumRateInfo,
        PRODUCTFEATURES as productFeatures,
        NOTICE as notice,
        IMAGEURL as imageUrl,
        TO_CHAR(CREATEDAT, 'YYYY-MM-DD HH24:MI:SS') as createdAt,
        TO_CHAR(UPDATEDAT, 'YYYY-MM-DD HH24:MI:SS') as updatedAt
        FROM PRODUCTDETAIL
        WHERE PRODUCTNO = #{productNo}
    </select>

    <!-- GPT 분석용 2025/11/26 김수진 -->
    <select id="findAllProductDetails" resultType="kr.co.busanbank.dto.ProductDetailDTO">
        SELECT
        PRODUCTNO AS productNo,
        PRODUCTFEATURES AS productFeatures
        FROM PRODUCTDETAIL
    </select>

    <!-- 검색 결과 페이지네이션 -->
    <select id="searchProductsPaged" resultType="kr.co.busanbank.dto.ProductDTO">
        SELECT *
        FROM PRODUCT
        WHERE PRODUCTNAME LIKE '%' || #{keyword} || '%'
        OR TO_CHAR(DESCRIPTION) LIKE '%' || #{keyword} || '%'
        ORDER BY PRODUCTNO
        OFFSET #{offset} ROWS
        FETCH NEXT #{size} ROWS ONLY
    </select>

    <select id="countSearchResults" resultType="int">
        SELECT COUNT(*)
        FROM PRODUCT
        WHERE PRODUCTNAME LIKE '%' || #{keyword} || '%'
        OR TO_CHAR(DESCRIPTION) LIKE '%' || #{keyword} || '%'
    </select>

    <!-- 메인 페이지 - 예금 상품 불러오기 25.11.26_수빈 -->
    <select id="getProductsByIds" resultType="kr.co.busanbank.dto.ProductDTO">
        SELECT
        p.PRODUCTNO as productNo,
        p.PRODUCTNAME as productName,
        p.PRODUCTTYPE as productType,
        p.CATEGORYID as categoryId,
        c.CATEGORYNAME as categoryName,
        p.DESCRIPTION as description,
        p.BASERATE as baseRate,
        p.MATURITYRATE as maturityRate,
        p.EARLYTERMINATERATE as earlyTerminateRate,
        p.MONTHLYAMOUNT as monthlyAmount,
        p.SAVINGTERM as savingTerm,
        p.DEPOSITAMOUNT as depositAmount,
        p.INTERESTMETHOD as interestMethod,
        p.PAYCYCLE as payCycle,
        TO_CHAR(p.ENDDATE, 'YYYY-MM-DD') as endDate,
        p.ADMINID as adminId,
        TO_CHAR(p.CREATEDAT, 'YYYY-MM-DD HH24:MI:SS') as createdAt,
        TO_CHAR(p.UPDATEDAT, 'YYYY-MM-DD HH24:MI:SS') as updatedAt,
        p.STATUS as status,
        p.HIT as hit
        FROM PRODUCT p
        LEFT JOIN CATEGORY c
        ON p.CATEGORYID = c.CATEGORYID
        WHERE p.PRODUCTNO IN
        <foreach collection="list" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
    </select>


    <!-- 전체 상품 목록 조회 (관리자용) -->
    <select id="selectAllProducts" resultType="kr.co.busanbank.dto.ProductDTO">
        SELECT
            PRODUCTNO as productNo,
            PRODUCTNAME as productName,
            PRODUCTTYPE as productType,
            CATEGORYID as categoryId,
            DESCRIPTION as description,
            BASERATE as baseRate,
            MATURITYRATE as maturityRate,
            EARLYTERMINATERATE as earlyTerminateRate,
            MONTHLYAMOUNT as monthlyAmount,
            SAVINGTERM as savingTerm,
            DEPOSITAMOUNT as depositAmount,
            INTERESTMETHOD as interestMethod,
            PAYCYCLE as payCycle,
            TO_CHAR(ENDDATE, 'YYYY-MM-DD') as endDate,
            ADMINID as adminId,
            TO_CHAR(CREATEDAT, 'YYYY-MM-DD HH24:MI:SS') as createdAt,
            TO_CHAR(UPDATEDAT, 'YYYY-MM-DD HH24:MI:SS') as updatedAt,
            STATUS as status,
            HIT as hit
        FROM PRODUCT
        WHERE STATUS = 'Y'
        ORDER BY PRODUCTNO DESC
    </select>

    <!-- 여기서 부터 아래 두 쿼리 ai 추천분석용 수진 -->
    <!-- 만기금리 기준 Top N -->
    <select id="findTopByOrderByMaturityRateDesc" resultType="kr.co.busanbank.dto.ProductDTO">
        SELECT *
        FROM PRODUCT
        ORDER BY MATURITYRATE DESC
        FETCH FIRST #{limit} ROWS ONLY
    </select>

    <!-- 적금/저축 상품 Top N -->
    <select id="findTopSavingsByRate" resultType="kr.co.busanbank.dto.ProductDTO">
        SELECT *
        FROM PRODUCT
        WHERE PRODUCTTYPE = '01'   <!-- 예금 -->
        PRODUCTNAME LIKE '%예금%'
        ORDER BY MATURITYRATE DESC
        FETCH FIRST #{limit} ROWS ONLY
    </select>

    <!-- 상품추천용 추가 -->
    <select id="findAllForRecommendation" resultType="kr.co.busanbank.dto.ProductDTO">
        SELECT PRODUCTNO AS productNo,
        PRODUCTNAME AS productName,
        DESCRIPTION,
        MATURITYRATE AS maturityRate
        FROM PRODUCT
        WHERE STATUS = 'Y'  <!-- 필요에 따라 필터 -->
    </select>

    <!-- 상품 조회수 증가 (작성자: 진원, 작성일: 2025-12-01) -->
    <update id="increaseProductHit" parameterType="int">
        UPDATE PRODUCT
        SET HIT = HIT + 1
        WHERE PRODUCTNO = #{productNo}
    </update>

    <!-- 예금상품 가입순 정렬, 조회 25.11.26_수빈 -->
    <select id="selectTopProductsBySubscribers" resultType="kr.co.busanbank.dto.ProductDTO">
        SELECT
            p.PRODUCTNO as productNo,
            p.PRODUCTNAME as productName,
            p.PRODUCTTYPE as productType,
            p.CATEGORYID as categoryId,
            c.CATEGORYNAME as categoryName,
            p.DESCRIPTION as description,

            (SELECT LISTAGG(JOINTYPE, ',') WITHIN GROUP (ORDER BY JOINTYPE)
            FROM PRODUCTJOINTYPE
            WHERE PRODUCTNO = p.PRODUCTNO) AS joinTypesStr,

            p.BASERATE as baseRate,
            p.MATURITYRATE as maturityRate,
            p.EARLYTERMINATERATE as earlyTerminateRate,
            p.MONTHLYAMOUNT as monthlyAmount,
            p.SAVINGTERM as savingTerm,
            p.DEPOSITAMOUNT as depositAmount,
            p.INTERESTMETHOD as interestMethod,
            p.PAYCYCLE as payCycle,
            TO_CHAR(p.ENDDATE, 'YYYY-MM-DD') as endDate,
            p.ADMINID as adminId,
            TO_CHAR(p.CREATEDAT, 'YYYY-MM-DD HH24:MI:SS') as createdAt,
            TO_CHAR(p.UPDATEDAT, 'YYYY-MM-DD HH24:MI:SS') as updatedAt,
            p.STATUS as status,
            p.HIT as hit,

            NVL(up.subscribers, 0) as subscriberCount

        FROM PRODUCT p
        LEFT JOIN CATEGORY c ON p.CATEGORYID = c.CATEGORYID
        LEFT JOIN (
        SELECT PRODUCTNO, COUNT(*) as subscribers
        FROM USERPRODUCT
        WHERE STATUS = 'A'
        GROUP BY PRODUCTNO
        ) up ON p.PRODUCTNO = up.PRODUCTNO

        WHERE p.STATUS = 'Y'
        ORDER BY NVL(up.subscribers, 0) DESC
        FETCH FIRST #{limit} ROWS ONLY
    </select>

</mapper>
