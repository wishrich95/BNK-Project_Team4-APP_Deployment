<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    ìž‘ì„±ìž: ì§„ì›
    ìž‘ì„±ì¼: 2025-11-28
    ì„¤ëª…: ì‚¬ìš©ìž ì¿ í° Mapper XML
-->
<mapper namespace="kr.co.busanbank.mapper.UserCouponMapper">

    <!-- ì‚¬ìš©ìž ì¿ í° ë“±ë¡ -->
    <insert id="insertUserCoupon" parameterType="kr.co.busanbank.dto.UserCouponDTO">
        <selectKey keyProperty="userCouponId" resultType="int" order="BEFORE">
            SELECT SEQUSERCOUPON.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO USERCOUPON (
            USERCOUPONID, USERID, COUPONID, ISSUEDDATE,
            STATUS, CREATEDAT
        ) VALUES (
            #{userCouponId}, #{userId}, #{couponId}, SYSDATE,
            'UNUSED', SYSDATE
        )
    </insert>

    <!-- ì‚¬ìš©ìžê°€ ë³´ìœ í•œ ì¿ í° ëª©ë¡ ì¡°íšŒ -->
    <select id="selectUserCouponsByUserId" resultType="kr.co.busanbank.dto.UserCouponDTO">
        SELECT
            uc.USERCOUPONID as userCouponId,
            uc.USERID as userId,
            uc.COUPONID as couponId,
            uc.ISSUEDDATE as issuedDate,
            uc.USEDDATE as usedDate,
            uc.PRODUCTNO as productNo,
            uc.STATUS as status,
            uc.CREATEDAT as createdAt,
            uc.UPDATEDAT as updatedAt,
            c.COUPONCODE as couponCode,
            c.COUPONNAME as couponName,
            c.RATEINCREASE as rateIncrease,
            c.VALIDTO as validTo,
            p.PRODUCTNAME as productName
        FROM USERCOUPON uc
        INNER JOIN COUPON c ON uc.COUPONID = c.COUPONID
        LEFT JOIN PRODUCT p ON uc.PRODUCTNO = p.PRODUCTNO
        WHERE uc.USERID = #{userId}
        ORDER BY uc.CREATEDAT DESC
    </select>

    <!-- ì‚¬ìš©ìžì˜ íŠ¹ì • ì¿ í° ì¡°íšŒ -->
    <select id="selectUserCouponById" resultType="kr.co.busanbank.dto.UserCouponDTO">
        SELECT
            uc.USERCOUPONID as userCouponId,
            uc.USERID as userId,
            uc.COUPONID as couponId,
            uc.ISSUEDDATE as issuedDate,
            uc.USEDDATE as usedDate,
            uc.PRODUCTNO as productNo,
            uc.STATUS as status,
            uc.CREATEDAT as createdAt,
            uc.UPDATEDAT as updatedAt,
            c.COUPONCODE as couponCode,
            c.COUPONNAME as couponName,
            c.RATEINCREASE as rateIncrease
        FROM USERCOUPON uc
        INNER JOIN COUPON c ON uc.COUPONID = c.COUPONID
        WHERE uc.USERCOUPONID = #{userCouponId}
    </select>

    <!-- ì¿ í° ì½”ë“œë¡œ ì¿ í° ì •ë³´ ì¡°íšŒ -->
    <select id="selectCouponByCode" resultType="kr.co.busanbank.dto.UserCouponDTO">
        SELECT
            c.COUPONID as couponId,
            c.COUPONCODE as couponCode,
            c.COUPONNAME as couponName,
            c.DESCRIPTION as description,
            c.RATEINCREASE as rateIncrease,
            c.MAXUSAGECOUNT as maxUsageCount,
            c.CURRENTUSAGECOUNT as currentUsageCount,
            c.VALIDFROM as validFrom,
            c.VALIDTO as validTo,
            c.ISACTIVE as isActive
        FROM COUPON c
        WHERE c.COUPONCODE = #{couponCode}
          AND c.STATUS = 'Y'
          AND c.ISACTIVE = 'Y'
    </select>

    <!-- ì‚¬ìš©ìžê°€ ì´ë¯¸ í•´ë‹¹ ì¿ í°ì„ ë“±ë¡í–ˆëŠ”ì§€ í™•ì¸ -->
    <select id="countUserCouponByUserIdAndCouponId" resultType="int">
        SELECT COUNT(*)
        FROM USERCOUPON
        WHERE USERID = #{userId}
          AND COUPONID = #{couponId}
    </select>

    <!-- ì¿ í° ì‚¬ìš© ì²˜ë¦¬ -->
    <update id="updateUserCouponUsed">
        UPDATE USERCOUPON
        SET STATUS = 'USED',
            USEDDATE = SYSDATE,
            PRODUCTNO = #{productNo},
            UPDATEDAT = SYSDATE
        WHERE USERCOUPONID = #{userCouponId}
    </update>

    <!-- ì‚¬ìš© ê°€ëŠ¥í•œ ì¿ í° ê°œìˆ˜ ì¡°íšŒ -->
    <select id="countAvailableCouponsByUserId" resultType="int">
        SELECT COUNT(*)
        FROM USERCOUPON uc
        INNER JOIN COUPON c ON uc.COUPONID = c.COUPONID
        WHERE uc.USERID = #{userId}
          AND uc.STATUS = 'UNUSED'
          AND SYSDATE <![CDATA[<=]]> c.VALIDTO
    </select>

    <!-- ì‚¬ìš©í•œ ì¿ í° ê°œìˆ˜ ì¡°íšŒ -->
    <select id="countUsedCouponsByUserId" resultType="int">
        SELECT COUNT(*)
        FROM USERCOUPON
        WHERE USERID = #{userId}
          AND STATUS = 'USED'
    </select>

    <!--  2025.11.28 ìˆ˜ì§„ -->
    <!-- ì‚¬ìš©ìžì˜ ì‚¬ìš© ê°€ëŠ¥í•œ ì¿ í° ì¡°íšŒ (ì¹´í…Œê³ ë¦¬ í•„í„°ë§) -->
    <select id="selectAvailableCouponsByCategory" resultType="kr.co.busanbank.dto.UserCouponDTO">
        SELECT
            uc.USERCOUPONID as userCouponId,
            uc.USERID as userId,
            uc.COUPONID as couponId,
            uc.ISSUEDDATE as issuedDate,
            uc.USEDDATE as usedDate,
            uc.PRODUCTNO as productNo,
            uc.STATUS as status,
            c.COUPONCODE as couponCode,
            c.COUPONNAME as couponName,
            c.DESCRIPTION as description,
            c.RATEINCREASE as rateIncrease,
            c.MAXUSAGECOUNT as maxUsageCount,
            c.CURRENTUSAGECOUNT as currentUsageCount,
            c.VALIDFROM as validFrom,
            c.VALIDTO as validTo,
            c.ISACTIVE as isActive
        FROM USERCOUPON uc
                 INNER JOIN COUPON c ON uc.COUPONID = c.COUPONID
                 INNER JOIN COUPONCATEGORY cc ON c.COUPONID = cc.COUPONID
        WHERE uc.USERID = #{userId}
          AND uc.STATUS = 'UNUSED'
          AND c.ISACTIVE = 'Y'
          AND c.STATUS = 'Y'
          AND SYSDATE BETWEEN c.VALIDFROM AND c.VALIDTO
          AND (c.MAXUSAGECOUNT = 0 OR c.CURRENTUSAGECOUNT <![CDATA[<]]> c.MAXUSAGECOUNT)
          AND cc.CATEGORYID = #{categoryId}
        ORDER BY c.RATEINCREASE DESC
    </select>

    <!-- ðŸ”¥ Flutter APIìš©: ì‚¬ìš© ê°€ëŠ¥í•œ ì¿ í° ì¡°íšŒ (2025-12-17 - ìž‘ì„±ìž: ì§„ì›) -->
    <select id="selectAvailableCoupons" resultType="kr.co.busanbank.dto.UserCouponDTO">
        SELECT
            uc.USERCOUPONID as userCouponId,
            uc.USERID as userId,
            uc.COUPONID as couponId,
            uc.ISSUEDDATE as issuedDate,
            uc.USEDDATE as usedDate,
            uc.PRODUCTNO as productNo,
            uc.STATUS as status,
            c.COUPONCODE as couponCode,
            c.COUPONNAME as couponName,
            c.DESCRIPTION as description,
            c.RATEINCREASE as bonusRate,
            c.VALIDFROM as validFrom,
            c.VALIDTO as expireDate,
            c.ISACTIVE as isActive
        FROM USERCOUPON uc
        INNER JOIN COUPON c ON uc.COUPONID = c.COUPONID
        WHERE uc.USERID = #{userNo}
          AND c.ISACTIVE = 'Y'
          AND c.STATUS = 'Y'
          AND (uc.STATUS = 'UNUSED' OR uc.STATUS = 'USED')
          AND SYSDATE <![CDATA[<=]]> c.VALIDTO
        ORDER BY uc.STATUS ASC, c.VALIDTO DESC
    </select>

    <!-- ðŸ”¥ Flutter APIìš©: ì‚¬ìš©ìž ë²ˆí˜¸ë¡œ ì¿ í° ì¡°íšŒ (2025-12-19 - ìž‘ì„±ìž: ì§„ì›) -->
    <select id="findByUserNo" resultType="kr.co.busanbank.dto.UserCouponDTO">
        SELECT
            UC.USERCOUPONID as ucNo,
            UC.USERID       as userNo,
            UC.COUPONID     as couponNo,
            C.COUPONNAME    as couponName,
            C.RATEINCREASE  as bonusRate,
            C.CATEGORYID    as categoryId,
            UC.PRODUCTNO    as productNo,
            TO_CHAR(UC.ISSUEDDATE, 'YYYY-MM-DD') as expireDate,
            UC.STATUS       as status
        FROM USERCOUPON UC
        INNER JOIN COUPON C ON UC.COUPONID = C.COUPONID
        WHERE UC.USERID = #{userNo}
          AND UC.STATUS = 'UNUSED'
    </select>

</mapper>
