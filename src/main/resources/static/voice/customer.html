<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>고객 음성 상담 (Agora)</title>
    <style>
        body { font-family: system-ui, -apple-system, "Segoe UI", sans-serif; margin: 24px; }
        .card { max-width: 560px; padding: 16px; border: 1px solid #ddd; border-radius: 12px; }
        label { display:block; margin-top: 12px; font-weight: 600; }
        input { width: 100%; padding: 10px; margin-top: 6px; border: 1px solid #ccc; border-radius: 10px; }
        button { margin-top: 12px; padding: 10px 12px; border-radius: 10px; border: 1px solid #333; background: #fff; cursor: pointer; }
        button:disabled { opacity: .5; cursor: not-allowed; }
        pre { background:#f7f7f7; padding: 12px; border-radius: 10px; overflow:auto; }
    </style>

    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.20.2.js"></script>
</head>

<body>
<h2>고객 음성 상담 (Web 테스트)</h2>

<div class="card">
    <label>세션 ID</label>
    <input id="sessionId" value="S123" />

    <button id="btnJoin">입장(Join)</button>
    <button id="btnLeave" disabled>나가기(Leave)</button>

    <pre id="log"></pre>
</div>

<script>
    const $ = (id) => document.getElementById(id);
    const logEl = $("log");
    function log(msg) {
        logEl.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
        logEl.scrollTop = logEl.scrollHeight;
    }

    const client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
    let localAudioTrack = null;

    client.on("user-published", async (user, mediaType) => {
        await client.subscribe(user, mediaType);
        log(`원격 유저 publish: uid=${user.uid}, type=${mediaType}`);
        if (mediaType === "audio") user.audioTrack.play();
    });

    async function fetchToken(sessionId) {
        const res = await fetch("/busanbank/api/call/token", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ sessionId, role: "CUSTOMER" })
        });
        if (!res.ok) throw new Error(`token api failed: ${res.status}`);
        return await res.json();
    }

    $("btnJoin").onclick = async () => {
        try {
            const sessionId = $("sessionId").value.trim();
            const { appId, channel, uid, token } = await fetchToken(sessionId);
            log(`토큰 수신: channel=${channel}, uid=${uid}`);

            await client.join(appId, channel, token, uid);
            localAudioTrack = await AgoraRTC.createMicrophoneAudioTrack();
            await client.publish([localAudioTrack]);

            $("btnJoin").disabled = true;
            $("btnLeave").disabled = false;
            log("입장 완료 + 마이크 publish 완료");
        } catch (e) {
            log(`ERROR: ${e.message}`);
            console.error(e);
        }
    };

    $("btnLeave").onclick = async () => {
        if (localAudioTrack) {
            localAudioTrack.stop();
            localAudioTrack.close();
            localAudioTrack = null;
        }
        await client.leave();
        $("btnJoin").disabled = false;
        $("btnLeave").disabled = true;
        log("leave 완료");
    };
</script>
</body>
</html>
