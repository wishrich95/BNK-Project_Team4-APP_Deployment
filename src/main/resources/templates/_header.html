<!--
    ìˆ˜ì •ì¼ : 2025/11/28
    ìˆ˜ì •ì : ì²œìˆ˜ë¹ˆ
    ë‚´ìš© : ì „ì²´ í—¤ë” ìˆ˜ì •

    JS í•„ìš”í•œ ì‚¬ëŒ ì˜ ì¶”ê°€í•˜ê¸°.
    <script th:src="@{/js/gnbDropdown.js}" defer></script>
    <script th:src="@{/js/translate.js}" defer></script>
    <script th:src="@{/js/globalBtn.js}" defer></script>
    <script th:src="@{/js/searchOverlay.js}" defer></script>
    <script th:src="@{/js/member/session-timer.js}" defer></script>
-->

<header th:fragment="headerFragment"
        xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6"
        th:class="${#authorization.expr('isAuthenticated()')} ? 'header login-on' : 'header'">

    <!-- Util ì˜ì—­ (ìµœìƒë‹¨) -->
    <article class="util-wrapper">
        <div class="util-inner container">

            <!-- ì˜¤ë¥¸ìª½: Util ë©”ë‰´ -->
            <div class="util-menu">
                <!-- ë¡œê·¸ì¸ ì •ë³´ (ë¡œê·¸ì¸ ì‹œì—ë§Œ í‘œì‹œ) -->
                <div class="login-info" sec:authorize="isAuthenticated()">
                    <a th:href="@{/my}" th:inline="text">[[${user.userName}]]ë‹˜</a>
                    <div class="session-box">
                        <p id="session-timer"></p>
                        <button type="button" class="extend-session">ì—°ì¥</button>
                    </div>
                </div>

                <!-- ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ (ë¡œê·¸ì¸ ì‹œ) -->
                <a sec:authorize="isAuthenticated()" th:href="@{/member/logout}">ë¡œê·¸ì•„ì›ƒ</a>

                <!-- ë¹„ë¡œê·¸ì¸ ìƒíƒœ ë¡œê·¸ì¸ ë²„íŠ¼ -->
                <a sec:authorize="!isAuthenticated()" th:href="@{/member/login}">ë¡œê·¸ì¸</a>

                <a th:href="@{/cs}">ê³ ê°ì„¼í„°</a>
                <a th:href="@{/company/companyintro}">ì€í–‰ì†Œê°œ</a>

                <!-- Global ë²„íŠ¼ -->
                <div class="global-wrap">
                    <button class="global-btn">
                        Global <i class="xi-caret-down-min global-icon"></i>
                    </button>

                    <div class="global-dropdown">
                        <div class="global-inner">
                            <a data-lang="ko"><img th:src="@{/images/main/kr1x1.png}"> í•œêµ­ì–´</a>
                            <a data-lang="en"><img th:src="@{/images/main/us1x1.png}"> English</a>
                            <a data-lang="jp"><img th:src="@{/images/main/jp1x1.png}"> æ—¥æœ¬èª</a>
                            <a data-lang="cn"><img th:src="@{/images/main/cn1x1.png}"> ä¸­æ–‡</a>
                        </div>
                    </div>
                </div>

                <!-- ê²€ìƒ‰ ì•„ì´ì½˜ -->
                <i class="xi-search search-open-btn"></i>
            </div>
        </div>
    </article>

    <!-- GNB ì˜ì—­ -->
    <article class="gnb-wrapper">
        <div class="gnb-inner container">
            <div class="logo-gnb-group">
                <!-- ë¡œê³  -->
                <a th:href="@{/}" class="header_logo">
                    <img class="logo-img" th:src="@{/images/main/TKBank_logo.png}" alt="ë”¸ê¹ì€í–‰ ë¡œê³ ">
                </a>

                <!-- GNB ë©”ë‰´ -->
                <nav class="gnb">
                    <!-- ì˜ˆê¸ˆ -->
                    <div class="menu-item" data-menu="ì˜ˆê¸ˆ">
                        <a href="#">ì˜ˆê¸ˆ</a>

                        <div class="submenu-wrap">
                            <div class="submenu-inner">
                                <!-- ì˜ˆê¸ˆìƒí’ˆ (CATEGORYID=1 í•˜ìœ„) -->
                                <div class="submenu-block">
                                    <h3 class="submenu-title">ì˜ˆê¸ˆìƒí’ˆ</h3>
                                    <div class="submenu-grid">
                                        <!-- DBì—ì„œ ê°€ì ¸ì˜¨ ì¹´í…Œê³ ë¦¬ -->
                                        <th:block th:each="category : ${headerCategories.depositProducts}">
                                            <a th:href="@{/prod/list(categoryId=${category.categoryId})}"
                                               th:text="${category.categoryName}">ì¹´í…Œê³ ë¦¬ëª…</a>
                                        </th:block>
                                    </div>
                                </div>

                                <!-- ì˜ˆê¸ˆì´ìš©ê°€ì´ë“œ (CATEGORYID=12 í•˜ìœ„) -->
                                <div class="submenu-block guide-block">
                                    <h3 class="submenu-title">ì˜ˆê¸ˆì´ìš©ê°€ì´ë“œ</h3>
                                    <div class="submenu-list">
                                        <th:block th:each="guide : ${headerCategories.depositGuides}">
                                            <a th:href="@{/guide(categoryId=${guide.categoryId})}"
                                               th:text="${guide.categoryName}">ê°€ì´ë“œëª…</a>
                                        </th:block>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ê¸ˆìœµì„œë¹„ìŠ¤ (CATEGORYID=15 í•˜ìœ„) -->
                    <div class="menu-item" data-menu="ê¸ˆìœµì„œë¹„ìŠ¤">
                        <a href="#">ê¸ˆìœµì„œë¹„ìŠ¤</a>

                        <div class="submenu-wrap">
                            <div class="submenu-inner">
                                <div class="submenu-block">
                                    <h3 class="submenu-title">ê¸ˆìœµì„œë¹„ìŠ¤</h3>
                                    <div class="submenu-grid">
                                        <th:block th:each="service : ${headerCategories.financialServices}">
                                            <a th:href="@{/service(categoryId=${service.categoryId})}"
                                               th:text="${service.categoryName}">ì„œë¹„ìŠ¤ëª…</a>
                                        </th:block>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ê¸ˆìœµê°ì •ë¶„ì„ -->
                    <div class="menu-item">
                        <a th:href="@{/prod/list/future}">ê¸ˆìœµê°ì •ë¶„ì„</a>
                    </div>

                    <!-- ê¸ˆìœµê²Œì„ -->
                    <div class="menu-item">
                        <a th:href="@{/quiz/quizdashboardcomplete}">ê¸ˆìœµê²Œì„</a>
                    </div>
                </nav>
            </div>
        </div>
    </article>

    <!-- ê²€ìƒ‰ì°½ ì˜¤ë²„ë ˆì´ -->
    <div class="search-overlay">
        <div class="search-bg"></div>

        <div class="search-inner-bg">
            <div class="search-inner">
                <h2>í‚¤ì›Œë“œ ê²€ìƒ‰</h2>
                <div class="search-box">
                    <input type="text" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.">
                    <button class="search-submit">
                        <i class="xi-search" id="openSearch"></i>
                    </button>
                </div>

                <button class="search-close">
                    <i class="xi-close"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- í¬ì¸íŠ¸ í† ìŠ¤íŠ¸ ì•Œë¦¼ (ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë§Œ) - ì‘ì„±ì: ì§„ì›, 2025-12-04 -->
    <div sec:authorize="isAuthenticated()" id="point-toast-container"></div>

    <!-- í¬ì¸íŠ¸ í† ìŠ¤íŠ¸ ì•Œë¦¼ CSS - ì‘ì„±ì: ì§„ì›, 2025-12-04 -->
    <style sec:authorize="isAuthenticated()">
        #point-toast-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .point-toast {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            min-width: 320px;
            max-width: 400px;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease-out, fadeOut 0.3s ease-in 4.7s;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .point-toast.removing {
            animation: slideOut 0.3s ease-out forwards;
        }

        .point-toast-icon {
            font-size: 32px;
            flex-shrink: 0;
        }

        .point-toast-content {
            flex: 1;
        }

        .point-toast-title {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .point-toast-message {
            font-size: 14px;
            opacity: 0.95;
        }

        .point-toast-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: background 0.2s;
            flex-shrink: 0;
        }

        .point-toast-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        @keyframes slideIn {
            from {
                transform: translateX(calc(100% + 30px));
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(calc(100% + 30px));
                opacity: 0;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0.7;
            }
        }

        @media (max-width: 768px) {
            #point-toast-container {
                bottom: 20px;
                right: 20px;
                left: 20px;
            }

            .point-toast {
                min-width: auto;
                width: 100%;
            }
        }
    </style>

    <!-- í¬ì¸íŠ¸ ì•Œë¦¼ WebSocket ì—°ê²° JavaScript - ì‘ì„±ì: ì§„ì›, 2025-12-04 -->
    <script sec:authorize="isAuthenticated()" th:inline="javascript">
        (function() {
            const userId = /*[[${user?.userNo}]]*/ null;

            if (!userId) {
                console.warn('âš ï¸ userIdê°€ ì—†ì–´ì„œ í¬ì¸íŠ¸ ì•Œë¦¼ WebSocket ì—°ê²°ì„ ê±´ë„ˆëœë‹ˆë‹¤.');
                return;
            }

            let pointWebSocket = null;
            let reconnectAttempts = 0;
            const MAX_RECONNECT_ATTEMPTS = 5;
            const RECONNECT_DELAY = 3000; // 3ì´ˆ

            function connectPointWebSocket() {
                try {
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const host = window.location.host;
                    const wsUrl = `${protocol}//${host}/busanbank/ws/point-notification?userId=${userId}`;

                    console.log('ğŸ”Œ í¬ì¸íŠ¸ ì•Œë¦¼ WebSocket ì—°ê²° ì‹œë„:', wsUrl);

                    pointWebSocket = new WebSocket(wsUrl);

                    pointWebSocket.onopen = function() {
                        console.log('âœ… í¬ì¸íŠ¸ ì•Œë¦¼ WebSocket ì—°ê²° ì„±ê³µ');
                        reconnectAttempts = 0;

                        // ì—°ê²° ìœ ì§€ë¥¼ ìœ„í•œ ì£¼ê¸°ì  ping (30ì´ˆë§ˆë‹¤)
                        setInterval(() => {
                            if (pointWebSocket && pointWebSocket.readyState === WebSocket.OPEN) {
                                pointWebSocket.send('ping');
                            }
                        }, 30000);
                    };

                    pointWebSocket.onmessage = function(event) {
                        console.log('ğŸ“© í¬ì¸íŠ¸ ì•Œë¦¼ ìˆ˜ì‹ :', event.data);

                        if (event.data === 'pong') {
                            return; // Ping/Pongì€ ë¬´ì‹œ
                        }

                        try {
                            const notification = JSON.parse(event.data);

                            if (notification.type === 'POINT_EARNED') {
                                showPointToast(notification.points, notification.message);
                            }
                        } catch (e) {
                            console.error('âŒ í¬ì¸íŠ¸ ì•Œë¦¼ íŒŒì‹± ì˜¤ë¥˜:', e);
                        }
                    };

                    pointWebSocket.onerror = function(error) {
                        console.error('âŒ í¬ì¸íŠ¸ ì•Œë¦¼ WebSocket ì˜¤ë¥˜:', error);
                    };

                    pointWebSocket.onclose = function(event) {
                        console.log('ğŸšª í¬ì¸íŠ¸ ì•Œë¦¼ WebSocket ì—°ê²° ì¢…ë£Œ:', event.code, event.reason);

                        // ì¬ì—°ê²° ì‹œë„
                        if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                            reconnectAttempts++;
                            console.log(`ğŸ”„ í¬ì¸íŠ¸ ì•Œë¦¼ WebSocket ì¬ì—°ê²° ì‹œë„ (${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})...`);
                            setTimeout(connectPointWebSocket, RECONNECT_DELAY);
                        } else {
                            console.warn('âš ï¸ í¬ì¸íŠ¸ ì•Œë¦¼ WebSocket ì¬ì—°ê²° ìµœëŒ€ ì‹œë„ íšŸìˆ˜ ì´ˆê³¼');
                        }
                    };
                } catch (error) {
                    console.error('âŒ í¬ì¸íŠ¸ ì•Œë¦¼ WebSocket ì—°ê²° ì‹¤íŒ¨:', error);
                }
            }

            function showPointToast(points, message) {
                const container = document.getElementById('point-toast-container');
                if (!container) return;

                // í† ìŠ¤íŠ¸ ì—˜ë¦¬ë¨¼íŠ¸ ìƒì„±
                const toast = document.createElement('div');
                toast.className = 'point-toast';
                toast.innerHTML = `
                    <div class="point-toast-icon">ğŸ’°</div>
                    <div class="point-toast-content">
                        <div class="point-toast-title">+${points} í¬ì¸íŠ¸ íšë“!</div>
                        <div class="point-toast-message">${message}</div>
                    </div>
                    <button class="point-toast-close" onclick="this.parentElement.remove()">Ã—</button>
                `;

                container.appendChild(toast);

                // 5ì´ˆ í›„ ìë™ ì œê±°
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.classList.add('removing');
                        setTimeout(() => {
                            if (toast.parentElement) {
                                toast.remove();
                            }
                        }, 300); // ì• ë‹ˆë©”ì´ì…˜ ì‹œê°„
                    }
                }, 5000);

                // ì˜¤ë””ì˜¤ íš¨ê³¼ (ì„ íƒì )
                try {
                    const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZURE');
                    audio.volume = 0.3;
                    audio.play().catch(() => {}); // ìë™ ì¬ìƒ ì°¨ë‹¨ ë¬´ì‹œ
                } catch (e) {}
            }

            // í˜ì´ì§€ ë¡œë“œ ì‹œ WebSocket ì—°ê²°
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', connectPointWebSocket);
            } else {
                connectPointWebSocket();
            }

            // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ WebSocket ì—°ê²° ì¢…ë£Œ
            window.addEventListener('beforeunload', function() {
                if (pointWebSocket) {
                    pointWebSocket.close();
                }
            });
        })();
    </script>
</header>