<!--adminbranch.html-->
<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë”¸ê¹ì€í–‰::ì˜ì—…ì  ê´€ë¦¬</title>

    <link rel="stylesheet" th:href="@{/css/admin/admin_category.css}">
    <link rel="stylesheet" th:href="@{/css/admin/admin_productList.css}">
    <link rel="stylesheet" th:href="@{/css/common/style_font.css}">

    <script th:src="@{/js/admin/admin_category.js}" defer></script>
    
    <!-- ì¹´ì¹´ì˜¤ë§µ API (ì‘ì„±ì: ì§„ì›, 2025-11-30) -->
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=fcb02db403a511ea44eb59837485cda6&libraries=services"></script>

    <!-- ë‹¤ìŒ ìš°í¸ë²ˆí˜¸ ì„œë¹„ìŠ¤ (ì‘ì„±ì: ì§„ì›, 2025-11-30) -->
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

    <style>
        /* Modal styles */
        .branch-modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 3% auto;
            padding: 30px;
            border: 1px solid #888;
            border-radius: 10px;
            width: 700px;
            max-width: 90%;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #E1545A;
            padding-bottom: 10px;
        }

        .modal-header h2 {
            margin: 0;
            color: #E1545A;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            flex: 1;
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-save {
            background-color: #E1545A;
            color: white;
        }

        .btn-save:hover {
            background-color: #c43f44;
        }

        .btn-cancel {
            background-color: #6c757d;
            color: white;
        }

        .btn-cancel:hover {
            background-color: #5a6268;
        }

        table {
            top: 135px !important;
        }

        .productList_title {
            top: 86px !important;
        }

        /* ì£¼ì†Œ ì…ë ¥ + ë²„íŠ¼ ìŠ¤íƒ€ì¼ (ì‘ì„±ì: ì§„ì›, 2025-11-30) */
        .address-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .address-input-wrapper input {
            flex: 1;
        }

        .btn-search-address {
            background-color: #007bff;
            color: white;
            padding: 8px 15px;
            border-radius: 4px;
            font-size: 13px;
            white-space: nowrap;
            min-width: 90px;
        }

        .btn-search-address:hover {
            background-color: #0056b3;
        }

        .coord-status {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .coord-status.success {
            color: #28a745;
        }

        .coord-status.error {
            color: #dc3545;
        }
    </style>
</head>
<body>
<div class="container" style="display:flex;">
    <!-- ì™¼ìª½ ì‚¬ì´ë“œë°” - Fragment ì‚¬ìš© -->
    <div th:replace="~{admin/_adminSidebar :: sidebar}"></div>

    <div class="main-right">
        <!-- ì˜ì—…ì  ëª©ë¡ ê´€ë¦¬ -->
        <div id="branchList">
            <div class="productList_title">
                <span class="title_sp">ì˜ì—…ì  ê´€ë¦¬</span>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="searchInput" class="search_input" placeholder="ì˜ì—…ì ëª… ê²€ìƒ‰"
                           style="height: 45px; width: 130px; padding: 10px; font-size: 18px;">
                    <button class="search_btn title_btn" onclick="searchBranches()" style="height: 45px; width: 50px; padding: 0px; font-size: 18px;">ê²€ìƒ‰</button>
                    <button class="title_btn" onclick="sortBranches('name')" style="height: 45px; width: 110px; padding: 0px; font-size: 18px;">ì˜ì—…ì ëª…ìˆœ</button>
                    <button class="title_btn" onclick="sortBranches('code')" style="height: 45px; width: 110px; padding: 0px; font-size: 18px;">ì§€ì ì½”ë“œìˆœ</button>
                    <button class="title_btn" id="addBranchBtn" style="height: 45px; width: 130px; padding: 0px; font-size: 18px;">ì˜ì—…ì  ì¶”ê°€</button>
                </div>
            </div>

            <table>
                <thead>
                    <tr style="background-color: #E1545A;color:white;">
                        <th style="border-radius: 5px 0 0 0; width: 5%;">ID</th>
                        <th style="width: 13%;">ì˜ì—…ì ëª…</th>
                        <th style="width: 7%;">ì§€ì ì½”ë“œ</th>
                        <th style="width: 7%;">ì§€ì—­ì½”ë“œ</th>
                        <th style="width: 18%;">ì£¼ì†Œ</th>
                        <th style="width: 9%;">ì „í™”ë²ˆí˜¸</th>
                        <th style="width: 9%;">íŒ©ìŠ¤ë²ˆí˜¸</th>
                        <th style="width: 7%;">ì§€ì ì¥</th>
                        <th style="width: 6%;">ìƒíƒœ</th>
                        <th style="width: 9%;">ë“±ë¡ì¼</th>
                        <th style="border-radius: 0 5px 0 0; width: 10%;">ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody id="branchTableBody">
                    <tr>
                        <td colspan="11" style="text-align:center; padding: 20px;">ë¡œë”© ì¤‘...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- ì˜ì—…ì  ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
<div id="branchModal" class="branch-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">ì˜ì—…ì  ì¶”ê°€</h2>
            <span class="close" onclick="closeBranchModal()">&times;</span>
        </div>
        <form id="branchForm">
            <input type="hidden" id="branchId">
            <input type="hidden" id="latitude">
            <input type="hidden" id="longitude">

            <!-- ì‘ì„±ì: ì§„ì›, 2025-12-03 ìˆ˜ì • - ì¤‘ë³µ ì²´í¬ ë²„íŠ¼ ì¶”ê°€ -->
            <div class="form-row">
                <div class="form-group">
                    <label for="branchName">ì˜ì—…ì ëª… *</label>
                    <div class="address-input-wrapper">
                        <input type="text" id="branchName" required>
                        <button type="button" class="modal-btn btn-search-address" onclick="checkBranchNameDuplicate()">ì¤‘ë³µí™•ì¸</button>
                    </div>
                    <span id="branchNameCheckMsg" style="font-size: 12px;"></span>
                </div>
                <div class="form-group">
                    <label for="branchCode">ì§€ì ì½”ë“œ *</label>
                    <div class="address-input-wrapper">
                        <input type="text" id="branchCode" required>
                        <button type="button" class="modal-btn btn-search-address" onclick="checkBranchCodeDuplicate()">ì¤‘ë³µí™•ì¸</button>
                    </div>
                    <span id="branchCodeCheckMsg" style="font-size: 12px;"></span>
                </div>
            </div>

            <!-- ì‘ì„±ì: ì§„ì›, 2025-12-03 ìˆ˜ì • - ì§€ì—­ì½”ë“œ select + ì§ì ‘ì…ë ¥ ì¶”ê°€ -->
            <div class="form-row">
                <div class="form-group">
                    <label for="regionCode">ì§€ì—­ì½”ë“œ</label>
                    <select id="regionCodeSelect" onchange="handleRegionCodeChange()" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 100%;">
                        <option value="">ì„ íƒ</option>
                        <option value="02">02 (ì„œìš¸)</option>
                        <option value="051">051 (ë¶€ì‚°)</option>
                        <option value="031">031 (ê²½ê¸°)</option>
                        <option value="032">032 (ì¸ì²œ)</option>
                        <option value="053">053 (ëŒ€êµ¬)</option>
                        <option value="062">062 (ê´‘ì£¼)</option>
                        <option value="042">042 (ëŒ€ì „)</option>
                        <option value="052">052 (ìš¸ì‚°)</option>
                        <option value="044">044 (ì„¸ì¢…)</option>
                        <option value="CUSTOM">ì§ì ‘ì…ë ¥</option>
                    </select>
                    <input type="text" id="regionCode" placeholder="ì§ì ‘ ì…ë ¥" style="margin-top: 5px; display: none;">
                </div>
                <div class="form-group">
                    <label for="manager">ì§€ì ì¥</label>
                    <input type="text" id="manager">
                </div>
            </div>

            <div class="form-group">
                <label for="address">ì£¼ì†Œ</label>
                <div class="address-input-wrapper">
                    <input type="text" id="address" placeholder="ì£¼ì†Œ ê²€ìƒ‰ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”" readonly>
                    <button type="button" class="modal-btn btn-search-address" onclick="searchAddress()">ğŸ” ì£¼ì†Œê²€ìƒ‰</button>
                </div>
                <div id="coordStatus" class="coord-status"></div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="tel">ì „í™”ë²ˆí˜¸</label>
                    <input type="text" id="tel">
                </div>
                <div class="form-group">
                    <label for="fax">íŒ©ìŠ¤ë²ˆí˜¸</label>
                    <input type="text" id="fax">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="openDate">ê°œì ì¼</label>
                    <input type="date" id="openDate">
                </div>
                <div class="form-group">
                    <label for="status">ìƒíƒœ *</label>
                    <select id="status" required>
                        <option value="Y">ìš´ì˜ì¤‘</option>
                        <option value="N">íì </option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="has365Corner">365ì½”ë„ˆ</label>
                    <select id="has365Corner">
                        <option value="N">ì—†ìŒ</option>
                        <option value="Y">ìˆìŒ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="hasForeignExchange">ì™¸êµ­í™˜</label>
                    <select id="hasForeignExchange">
                        <option value="N">ì—†ìŒ</option>
                        <option value="Y">ìˆìŒ</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="hasSafebox">ëŒ€ì—¬ê¸ˆê³ </label>
                    <select id="hasSafebox">
                        <option value="N">ì—†ìŒ</option>
                        <option value="Y">ìˆìŒ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="hasNightSafebox">ì•¼ê°„ê¸ˆê³ </label>
                    <select id="hasNightSafebox">
                        <option value="N">ì—†ìŒ</option>
                        <option value="Y">ìˆìŒ</option>
                    </select>
                </div>
            </div>

            <div class="modal-buttons" style="justify-content: space-between;">
                <button type="button" class="modal-btn" id="deleteBranchBtn" style="background-color: #dc3545; color: white; display: none;" onclick="deleteCurrentBranch()">ì‚­ì œ</button>
                <div style="display: flex; gap: 10px;">
                    <button type="button" class="modal-btn btn-cancel" onclick="closeBranchModal()">ì·¨ì†Œ</button>
                    <button type="button" class="modal-btn btn-save" id="saveBranchBtn">ì €ì¥</button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    // ì „ì—­ ë³€ìˆ˜
    let allBranchesData = [];
    let geocoder = null; // ì¹´ì¹´ì˜¤ Geocoder ê°ì²´

    // ì¹´ì¹´ì˜¤ë§µ ì´ˆê¸°í™” (ì‘ì„±ì: ì§„ì›, 2025-11-30)
    kakao.maps.load(function() {
        geocoder = new kakao.maps.services.Geocoder();
    });

    // í˜ì´ì§€ ë¡œë”© ì‹œ ì˜ì—…ì  ëª©ë¡ ì¡°íšŒ (ì‘ì„±ì: ì§„ì›, 2025-11-30)
    document.addEventListener('DOMContentLoaded', () => {
        loadBranchList();

        // ì˜ì—…ì  ì¶”ê°€ ë²„íŠ¼ ì´ë²¤íŠ¸
        document.getElementById('addBranchBtn').addEventListener('click', openAddBranchModal);

        // ì˜ì—…ì  ì €ì¥ ë²„íŠ¼ ì´ë²¤íŠ¸
        document.getElementById('saveBranchBtn').addEventListener('click', saveBranch);

        // ê²€ìƒ‰ ì—”í„°í‚¤ ì´ë²¤íŠ¸
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchBranches();
            }
        });
    });

    // ì˜ì—…ì  ëª©ë¡ ì¡°íšŒ (ì‘ì„±ì: ì§„ì›, 2025-11-30)
    function loadBranchList() {
        fetch('/busanbank/admin/branch/branches')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    allBranchesData = data.data;
                    displayBranchList(allBranchesData);
                } else {
                    alert('ì˜ì—…ì  ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ì˜ì—…ì  ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            });
    }

    // ì˜ì—…ì  ëª©ë¡ í‘œì‹œ (ì‘ì„±ì: ì§„ì›, 2025-11-30)
    function displayBranchList(branches) {
        const tbody = document.getElementById('branchTableBody');

        if (!branches || branches.length === 0) {
            tbody.innerHTML = '<tr><td colspan="11" style="text-align:center; padding: 20px;">ì˜ì—…ì ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            return;
        }

        tbody.innerHTML = branches.map((branch, index) => `
            <tr class="${index === branches.length - 1 ? 'content_tr_last' : 'content_tr'}">
                <td${index === branches.length - 1 ? ' style="border-radius: 0 0 0 5px; text-align: center;"' : ' style="text-align: center;"'}>${branch.branchId}</td>
                <td style="text-align: left; padding-left: 10px;">${branch.branchName}</td>
                <td style="text-align: center;">${branch.branchCode || '-'}</td>
                <td style="text-align: center;">${branch.regionCode || '-'}</td>
                <td style="text-align: left; padding-left: 10px;">${branch.address || '-'}</td>
                <td style="text-align: center;">${branch.tel || '-'}</td>
                <td style="text-align: center;">${branch.fax || '-'}</td>
                <td style="text-align: center;">${branch.manager || '-'}</td>
                <td style="text-align: center;">
                    <span style="color: ${branch.status === 'Y' ? '#28a745' : '#dc3545'};">
                        ${branch.status === 'Y' ? 'ìš´ì˜ì¤‘' : 'íì '}
                    </span>
                </td>
                <td style="text-align: center;">${branch.createdAt ? branch.createdAt.substring(0, 10) : '-'}</td>
                <td${index === branches.length - 1 ? ' style="border-radius: 0 0 5px 0; text-align: center;"' : ' style="text-align: center;"'}>
                    <button class="productList_btn" onclick="editBranch(${branch.branchId})" title="ìˆ˜ì •">
                        <img src="/busanbank/images/admin/free-icon-pencil-7175371.png" alt="ìˆ˜ì • ë²„íŠ¼" style="width: 100%;height: 100%;object-fit: contain;">
                    </button>
                </td>
            </tr>
        `).join('');
    }

    // ê²€ìƒ‰ ê¸°ëŠ¥ (ì‘ì„±ì: ì§„ì›, 2025-11-30)
    function searchBranches() {
        const searchKeyword = document.getElementById('searchInput').value.toLowerCase();

        if (!searchKeyword.trim()) {
            displayBranchList(allBranchesData);
            return;
        }

        const filteredBranches = allBranchesData.filter(branch =>
            branch.branchName.toLowerCase().includes(searchKeyword)
        );

        displayBranchList(filteredBranches);
    }

    // ì •ë ¬ ê¸°ëŠ¥ (ì‘ì„±ì: ì§„ì›, 2025-11-30)
    function sortBranches(sortType) {
        if (!allBranchesData || allBranchesData.length === 0) {
            return;
        }

        let sortedBranches = [...allBranchesData];

        switch(sortType) {
            case 'name':
                sortedBranches.sort((a, b) => a.branchName.localeCompare(b.branchName));
                break;
            case 'code':
                sortedBranches.sort((a, b) => (a.branchCode || '').localeCompare(b.branchCode || ''));
                break;
        }

        displayBranchList(sortedBranches);
    }

    // ì˜ì—…ì  ì¶”ê°€ ëª¨ë‹¬ ì—´ê¸° (ì‘ì„±ì: ì§„ì›, 2025-11-30)
    function openAddBranchModal() {
        document.getElementById('modalTitle').textContent = 'ì˜ì—…ì  ì¶”ê°€';
        document.getElementById('branchForm').reset();
        document.getElementById('branchId').value = '';
        document.getElementById('deleteBranchBtn').style.display = 'none';
        document.getElementById('status').value = 'Y';
        document.getElementById('has365Corner').value = 'N';
        document.getElementById('hasForeignExchange').value = 'N';
        document.getElementById('hasSafebox').value = 'N';
        document.getElementById('hasNightSafebox').value = 'N';
        document.getElementById('branchModal').style.display = 'block';
    }

    // ì˜ì—…ì  ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸° (ì‘ì„±ì: ì§„ì›, 2025-11-30)
    function editBranch(branchId) {
        fetch(`/busanbank/admin/branch/branches/${branchId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const branch = data.data;

                    document.getElementById('modalTitle').textContent = 'ì˜ì—…ì  ìˆ˜ì •';
                    document.getElementById('branchId').value = branch.branchId;
                    document.getElementById('branchName').value = branch.branchName;
                    document.getElementById('branchCode').value = branch.branchCode || '';

                    // ì§€ì—­ì½”ë“œ ì„¤ì • (ì‘ì„±ì: ì§„ì›, 2025-12-03 - select ì˜µì…˜ ì²˜ë¦¬ ì¶”ê°€)
                    const regionCode = branch.regionCode || '';
                    const regionCodeSelect = document.getElementById('regionCodeSelect');
                    const regionCodeInput = document.getElementById('regionCode');

                    // selectì— í•´ë‹¹ ê°’ì´ ìˆëŠ”ì§€ í™•ì¸
                    const optionExists = Array.from(regionCodeSelect.options).some(option => option.value === regionCode);

                    if (optionExists && regionCode) {
                        regionCodeSelect.value = regionCode;
                        regionCodeInput.style.display = 'none';
                        regionCodeInput.value = regionCode;
                    } else if (regionCode) {
                        // selectì— ì—†ëŠ” ê°’ì´ë©´ ì§ì ‘ì…ë ¥
                        regionCodeSelect.value = 'CUSTOM';
                        regionCodeInput.style.display = 'block';
                        regionCodeInput.value = regionCode;
                    } else {
                        // ê°’ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’
                        regionCodeSelect.value = '';
                        regionCodeInput.style.display = 'none';
                        regionCodeInput.value = '';
                    }

                    document.getElementById('address').value = branch.address || '';
                    document.getElementById('tel').value = branch.tel || '';
                    document.getElementById('fax').value = branch.fax || '';
                    document.getElementById('manager').value = branch.manager || '';
                    document.getElementById('openDate').value = branch.openDate || '';
                    document.getElementById('latitude').value = branch.latitude || '';
                    document.getElementById('longitude').value = branch.longitude || '';
                    document.getElementById('status').value = branch.status || 'Y';

                    // ì¢Œí‘œ ìƒíƒœ í‘œì‹œ (ì‘ì„±ì: ì§„ì›, 2025-11-30)
                    updateCoordStatus();
                    document.getElementById('has365Corner').value = branch.has365Corner || 'N';
                    document.getElementById('hasForeignExchange').value = branch.hasForeignExchange || 'N';
                    document.getElementById('hasSafebox').value = branch.hasSafebox || 'N';
                    document.getElementById('hasNightSafebox').value = branch.hasNightSafebox || 'N';

                    document.getElementById('deleteBranchBtn').style.display = 'block';
                    document.getElementById('branchModal').style.display = 'block';
                } else {
                    alert('ì˜ì—…ì  ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ì˜ì—…ì  ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            });
    }

    // ì˜ì—…ì ëª… ì¤‘ë³µ ì²´í¬ (ì‘ì„±ì: ì§„ì›, 2025-12-03)
    async function checkBranchNameDuplicate() {
        const branchId = document.getElementById('branchId').value;
        const branchName = document.getElementById('branchName').value.trim();
        const msgEl = document.getElementById('branchNameCheckMsg');

        if (!branchName) {
            msgEl.textContent = 'ì˜ì—…ì ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
            msgEl.style.color = 'red';
            return;
        }

        try {
            const response = await fetch(`/busanbank/admin/branch/check-name?branchName=${encodeURIComponent(branchName)}&excludeId=${branchId || ''}`);
            const data = await response.json();

            if (data.isDuplicate) {
                msgEl.textContent = 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì˜ì—…ì ëª…ì…ë‹ˆë‹¤.';
                msgEl.style.color = 'red';
            } else {
                msgEl.textContent = 'ì‚¬ìš© ê°€ëŠ¥í•œ ì˜ì—…ì ëª…ì…ë‹ˆë‹¤.';
                msgEl.style.color = 'green';
            }
        } catch (error) {
            console.error('ì˜ì—…ì ëª… ì¤‘ë³µ ì²´í¬ ì˜¤ë¥˜:', error);
            msgEl.textContent = 'ì¤‘ë³µ ì²´í¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            msgEl.style.color = 'red';
        }
    }

    // ì§€ì ì½”ë“œ ì¤‘ë³µ ì²´í¬ (ì‘ì„±ì: ì§„ì›, 2025-12-03)
    async function checkBranchCodeDuplicate() {
        const branchId = document.getElementById('branchId').value;
        const branchCode = document.getElementById('branchCode').value.trim();
        const msgEl = document.getElementById('branchCodeCheckMsg');

        if (!branchCode) {
            msgEl.textContent = 'ì§€ì ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
            msgEl.style.color = 'red';
            return;
        }

        try {
            const response = await fetch(`/busanbank/admin/branch/check-code?branchCode=${encodeURIComponent(branchCode)}&excludeId=${branchId || ''}`);
            const data = await response.json();

            if (data.isDuplicate) {
                msgEl.textContent = 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì§€ì ì½”ë“œì…ë‹ˆë‹¤.';
                msgEl.style.color = 'red';
            } else {
                msgEl.textContent = 'ì‚¬ìš© ê°€ëŠ¥í•œ ì§€ì ì½”ë“œì…ë‹ˆë‹¤.';
                msgEl.style.color = 'green';
            }
        } catch (error) {
            console.error('ì§€ì ì½”ë“œ ì¤‘ë³µ ì²´í¬ ì˜¤ë¥˜:', error);
            msgEl.textContent = 'ì¤‘ë³µ ì²´í¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            msgEl.style.color = 'red';
        }
    }

    // ì§€ì—­ì½”ë“œ ì„ íƒ ì²˜ë¦¬ (ì‘ì„±ì: ì§„ì›, 2025-12-03)
    function handleRegionCodeChange() {
        const select = document.getElementById('regionCodeSelect');
        const input = document.getElementById('regionCode');

        if (select.value === 'CUSTOM') {
            input.style.display = 'block';
            input.value = '';
            input.focus();
        } else {
            input.style.display = 'none';
            input.value = select.value;
        }
    }

    // ì˜ì—…ì  ì €ì¥ (ì‘ì„±ì: ì§„ì›, 2025-11-30, ìˆ˜ì •: ì§„ì› 2025-12-03)
    function saveBranch() {
        const branchId = document.getElementById('branchId').value;
        const branchName = document.getElementById('branchName').value;
        const branchCode = document.getElementById('branchCode').value;

        if (!branchName || !branchCode) {
            alert('ì˜ì—…ì ëª…ê³¼ ì§€ì ì½”ë“œëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.');
            return;
        }

        // ì§€ì—­ì½”ë“œ ì²˜ë¦¬ (select ë˜ëŠ” ì§ì ‘ì…ë ¥)
        const regionCodeSelect = document.getElementById('regionCodeSelect');
        const regionCodeInput = document.getElementById('regionCode');
        const regionCode = regionCodeSelect.value === 'CUSTOM' ? regionCodeInput.value : regionCodeSelect.value;

        const branchData = {
            branchName: branchName,
            branchCode: branchCode,
            regionCode: regionCode,
            address: document.getElementById('address').value,
            tel: document.getElementById('tel').value,
            fax: document.getElementById('fax').value,
            manager: document.getElementById('manager').value,
            latitude: document.getElementById('latitude').value || null,
            longitude: document.getElementById('longitude').value || null,
            openDate: document.getElementById('openDate').value,
            status: document.getElementById('status').value,
            has365Corner: document.getElementById('has365Corner').value,
            hasForeignExchange: document.getElementById('hasForeignExchange').value,
            hasSafebox: document.getElementById('hasSafebox').value,
            hasNightSafebox: document.getElementById('hasNightSafebox').value
        };

        const url = branchId
            ? `/busanbank/admin/branch/branches/${branchId}`
            : '/busanbank/admin/branch/branches';

        const method = branchId ? 'PUT' : 'POST';

        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(branchData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                closeBranchModal();
                loadBranchList();
            } else {
                alert(data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('ì˜ì—…ì  ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
    }

    // ì˜ì—…ì  ì‚­ì œ (ì‘ì„±ì: ì§„ì›, 2025-11-30)
    function deleteCurrentBranch() {
        if (!confirm('ì •ë§ë¡œ ì´ ì˜ì—…ì ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            return;
        }

        const branchId = document.getElementById('branchId').value;

        fetch(`/busanbank/admin/branch/branches/${branchId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                closeBranchModal();
                loadBranchList();
            } else {
                alert(data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('ì˜ì—…ì  ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
    }

    // ì£¼ì†Œ ê²€ìƒ‰ íŒì—… ì—´ê¸° (ì‘ì„±ì: ì§„ì›, 2025-11-30)
    function searchAddress() {
        new daum.Postcode({
            oncomplete: function(data) {
                // ë„ë¡œëª… ì£¼ì†Œê°€ ìˆìœ¼ë©´ ë„ë¡œëª…, ì—†ìœ¼ë©´ ì§€ë²ˆ ì£¼ì†Œ ì‚¬ìš©
                let fullAddress = data.roadAddress || data.jibunAddress;

                // ê±´ë¬¼ëª…ì´ ìˆê³ , ê³µë™ì£¼íƒì¼ ê²½ìš° ì¶”ê°€
                if (data.buildingName !== '' && /[ë™|ë¡œ|ê°€]$/g.test(data.buildingName) === false) {
                    fullAddress += ' (' + data.buildingName + ')';
                }

                // ì£¼ì†Œ í•„ë“œì— ê°’ ì„¤ì •
                document.getElementById('address').value = fullAddress;

                // ì£¼ì†Œ ì…ë ¥ í›„ ìë™ìœ¼ë¡œ ì¢Œí‘œ ì°¾ê¸° ì‹¤í–‰
                getCoordinatesFromAddress();
            }
        }).open();
    }

    // ì£¼ì†Œë¡œ ì¢Œí‘œ ì°¾ê¸° (ì‘ì„±ì: ì§„ì›, 2025-11-30)
    function getCoordinatesFromAddress() {
        const address = document.getElementById('address').value.trim();

        if (!address) {
            alert('ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        if (!geocoder) {
            alert('ì¹´ì¹´ì˜¤ë§µ APIê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            return;
        }

        // ì¢Œí‘œ ì°¾ëŠ” ì¤‘ í‘œì‹œ
        updateCoordStatus('ê²€ìƒ‰ ì¤‘...', 'searching');

        // ì£¼ì†Œë¡œ ì¢Œí‘œ ê²€ìƒ‰
        geocoder.addressSearch(address, function(result, status) {
            if (status === kakao.maps.services.Status.OK) {
                const lat = result[0].y;
                const lng = result[0].x;

                document.getElementById('latitude').value = lat;
                document.getElementById('longitude').value = lng;

                updateCoordStatus(`âœ“ ì¢Œí‘œ ì°¾ê¸° ì„±ê³µ (ìœ„ë„: ${lat}, ê²½ë„: ${lng})`, 'success');
            } else {
                updateCoordStatus('âœ— ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì •í™•í•œ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                document.getElementById('latitude').value = '';
                document.getElementById('longitude').value = '';
            }
        });
    }

    // ì¢Œí‘œ ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸ (ì‘ì„±ì: ì§„ì›, 2025-11-30)
    function updateCoordStatus(message, type) {
        const statusElement = document.getElementById('coordStatus');

        if (!message) {
            const lat = document.getElementById('latitude').value;
            const lng = document.getElementById('longitude').value;

            if (lat && lng) {
                statusElement.textContent = `í˜„ì¬ ì¢Œí‘œ: ìœ„ë„ ${lat}, ê²½ë„ ${lng}`;
                statusElement.className = 'coord-status success';
            } else {
                statusElement.textContent = '';
                statusElement.className = 'coord-status';
            }
        } else {
            statusElement.textContent = message;
            statusElement.className = `coord-status ${type}`;
        }
    }

    // ëª¨ë‹¬ ë‹«ê¸° (ì‘ì„±ì: ì§„ì›, 2025-11-30)
    function closeBranchModal() {
        document.getElementById('branchModal').style.display = 'none';
        document.getElementById('branchForm').reset();
        document.getElementById('coordStatus').textContent = '';
    }

    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    window.onclick = function(event) {
        const modal = document.getElementById('branchModal');
        if (event.target === modal) {
            closeBranchModal();
        }
    }
</script>

</body>
</html>
