<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë”¸ê¹ì€í–‰::ì˜ì—…ì  ë°©ë¬¸ ì²´í¬ì¸</title>

    <link rel="stylesheet" th:href="@{/css/common/style_font.css}">
    <link rel="stylesheet" th:href="@{/css/common/style_common.css}">
    <link href="//cdn.jsdelivr.net/xeicon/2/xeicon.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/_header.css}">
    <link rel="stylesheet" th:href="@{/css/_footer.css}">
    <link rel="stylesheet" th:href="@{/css/member/AutoLogout.css}">

    <script th:src="@{/js/translate.js}" defer></script>
    <script th:src="@{/js/globalBtn.js}" defer></script>
    <script th:src="@{/js/searchOverlay.js}" defer></script>
    <script th:src="@{/js/gnbDropdown.js}" defer></script>
    <script th:src="@{/js/member/session-timer.js}" defer></script>

    <!-- ì¹´ì¹´ì˜¤ë§µ API (ì‘ì„±ì: ì§„ì›, 2025-11-30, ìˆ˜ì •: ì§„ì› 2025-12-03 - services ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€) -->
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=fcb02db403a511ea44eb59837485cda6&libraries=services"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body { background-color: #f5f5f5; }

        .map-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 0;
        }

        .page-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .page-header-title {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            margin-bottom: 10px;
        }

        .page-header img {
            width: auto;
            height: 30px;
            margin-right: 10px;
        }

        .page-header h1 {
            font-size: 30px;
            font-weight: 700;
        }

        .page-header p {
            font-size: 18px;
            font-weight: 500;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
            margin-bottom: 20px;
        }

        .map-section {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .map-controls {
            padding: 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .map-legend {
            display: flex;
            justify-content: flex-start;
            align-items: center;

            gap: 20px;
            font-size: 20px;
            font-weight: 500;
        }

        .map-legend img {
            width: 25px;
            height: auto;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-icon {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .legend-icon.user {
            background-color: #ff5757;
            border: 2px solid #fff;
            box-shadow: 0 0 0 2px #ff5757;
        }

        .legend-icon.branch {
            background-color: #ffc107;
            border: 2px solid #fff;
            box-shadow: 0 0 0 2px #ffc107;
        }

        .legend-icon.range {
            background-color: #4285F4;
            opacity: 0.3;
            border: 2px solid #4285F4;
        }

        .map-controls button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-location {
            background-color: var(--purple-900);
            color: white;
        }

        .btn-location:hover {
            background-color: #541d6c;
        }

        .btn-location:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        #map {
            width: 100%;
            height: 600px;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .info-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .info-card h3 {
            font-size: 22px;
            font-weight: 700;
            color: var(--purple-900);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--purple-900);
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .status-label {
            color: #666;
            font-size: 18px;
            font-weight: 500;
        }

        .status-value {
            color: var(--grey-900);
            font-size: 18px;
            font-weight: 500;
        }

        .status-value.success {
            color: #28a745;
        }

        .status-value.danger {
            color: #dc3545;
        }

        .btn-checkin {
            width: 100%;
            padding: 15px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s;
        }

        .btn-checkin:hover:not(:disabled) {
            background-color: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
        }

        .btn-checkin:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .history-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .history-item {
            padding: 12px;
            border-radius: 8px;
            background: #f8f9fa;
            margin-bottom: 10px;
        }

        .history-item .branch-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .history-item .date {
            font-size: 12px;
            color: #666;
        }

        .history-item .coins {
            font-size: 14px;
            color: #E1545A;
            font-weight: bold;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        @media (max-width: 968px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .sidebar {
                order: -1;
            }

            .map-controls {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }

            .map-legend {
                flex-wrap: wrap;
                gap: 10px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <!-- í—¤ë” -->
    <div th:replace="~{_header :: headerFragment}"></div>

    <div class="map-container">
        <!-- í˜ì´ì§€ í—¤ë” -->
        <div class="page-header">
            <div class="page-header-title">
                <img th:src="@{/images/quiz/map.png}"></img><h1>ì˜ì—…ì  ë°©ë¬¸ ì²´í¬ì¸</h1>
            </div>
            <p>ì˜ì—…ì  200m ì´ë‚´ì—ì„œ ì²´í¬ì¸í•˜ê³  100 í¬ì¸íŠ¸ë¥¼ ë°›ìœ¼ì„¸ìš”!</p>
        </div>

        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <div class="main-content">
            <!-- ì§€ë„ ì˜ì—­ -->
            <div class="map-section">
                <div class="map-controls">
                    <div class="map-legend">
                        <span style="display: flex;justify-content: flex-start;align-items: flex-start;font-weight: bold;color: #333;">
                            <img style="margin-right: 10px" th:src="@{/images/quiz/world-map.png}"></img> ì§€ë„ ë²”ë¡€:
                        </span>
                        <div class="legend-item">
                            <div class="legend-icon user"></div>
                            <span>ë‚´ ìœ„ì¹˜</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-icon branch"></div>
                            <span>ì˜ì—…ì </span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-icon range"></div>
                            <span>ì²´í¬ì¸ ê°€ëŠ¥ ë²”ìœ„ (200m)</span>
                        </div>
                    </div>
                    <button class="btn-location" id="btnMyLocation">
                        ë‚´ ìœ„ì¹˜ë¡œ ì´ë™
                    </button>
                </div>
                <div id="map"></div>
            </div>

            <!-- ì‚¬ì´ë“œë°” -->
            <div class="sidebar">
                <!-- ì²´í¬ì¸ ìƒíƒœ ì¹´ë“œ -->
                <div class="info-card">
                    <h3>ì²´í¬ì¸ ì •ë³´</h3>
                    <div class="status-item">
                        <span class="status-label">ì˜¤ëŠ˜ ì²´í¬ì¸</span>
                        <span class="status-value" id="todayStatus">í™•ì¸ ì¤‘...</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">ë‚´ ìœ„ì¹˜ ì£¼ì†Œ</span>
                        <span class="status-value" id="myAddress" style="font-size: 16px; line-height: 1.5;">-</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">ê°€ê¹Œìš´ ì˜ì—…ì </span>
                        <span class="status-value" id="nearestBranch">-</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">ê±°ë¦¬</span>
                        <span class="status-value" id="distance">-</span>
                    </div>
                    <button class="btn-checkin" id="btnCheckin" disabled>
                        ì²´í¬ì¸í•˜ê¸°
                    </button>
                </div>

                <!-- ì²´í¬ì¸ íˆìŠ¤í† ë¦¬ ì¹´ë“œ -->
                <div class="info-card">
                    <h3>ìµœê·¼ ì²´í¬ì¸ ê¸°ë¡</h3>
                    <div class="history-list" id="historyList">
                        <div class="loading">ë¡œë”© ì¤‘...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜ (ì‘ì„±ì: ì§„ì›, 2025-11-30)
        let map;
        let userMarker;
        let userCircle;
        let userPosition = null;
        let branches = [];
        let nearestBranch = null;
        let canCheckinToday = false;
        let currentInfowindow = null; // í˜„ì¬ ì—´ë ¤ìˆëŠ” ì¸í¬ìœˆë„ìš°

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            loadBranches();
            checkTodayStatus();
            loadHistory();

            // ë‚´ ìœ„ì¹˜ë¡œ ì´ë™ ë²„íŠ¼
            document.getElementById('btnMyLocation').addEventListener('click', getUserLocation);

            // ì²´í¬ì¸ ë²„íŠ¼
            document.getElementById('btnCheckin').addEventListener('click', doCheckin);
        });

        // ì§€ë„ ì´ˆê¸°í™” (ì‘ì„±ì: ì§„ì›, 2025-11-30)
        function initMap() {
            const container = document.getElementById('map');
            const options = {
                center: new kakao.maps.LatLng(35.1796, 129.0756), // ë¶€ì‚° ì¤‘ì‹¬
                level: 5
            };

            map = new kakao.maps.Map(container, options);

            // ì§€ë„ í´ë¦­ ì‹œ ì¸í¬ìœˆë„ìš° ë‹«ê¸°
            kakao.maps.event.addListener(map, 'click', function() {
                if (currentInfowindow) {
                    currentInfowindow.close();
                    currentInfowindow = null;
                }
            });

            // ì‚¬ìš©ì ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°
            getUserLocation();
        }

        // ì‚¬ìš©ì ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸° (ì‘ì„±ì: ì§„ì›, 2025-11-30)
        function getUserLocation() {
            if (navigator.geolocation) {
                document.getElementById('btnMyLocation').disabled = true;
                document.getElementById('btnMyLocation').textContent = 'ìœ„ì¹˜ í™•ì¸ ì¤‘...';

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;

                        userPosition = { lat, lon };

                        // ì§€ë„ ì¤‘ì‹¬ ì´ë™
                        const moveLatLon = new kakao.maps.LatLng(lat, lon);
                        map.setCenter(moveLatLon);
                        map.setLevel(3); // ì¤Œ ë ˆë²¨ ì¡°ì • (ë” ê°€ê¹Œì´)

                        // ê¸°ì¡´ ë§ˆì»¤/ì› ì œê±°
                        if (userMarker) {
                            userMarker.setMap(null);
                        }
                        if (userCircle) {
                            userCircle.setMap(null);
                        }

                        // ì‚¬ìš©ì ìœ„ì¹˜ ë§ˆì»¤ í‘œì‹œ (íŒŒë€ìƒ‰ ì»¤ìŠ¤í…€ ì´ë¯¸ì§€)
                        const imageSrc = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_red.png';
                        const imageSize = new kakao.maps.Size(34, 39);
                        const imageOption = {offset: new kakao.maps.Point(17, 39)};
                        const markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imageOption);

                        userMarker = new kakao.maps.Marker({
                            map: map,
                            position: moveLatLon,
                            image: markerImage,
                            title: 'ë‚´ ìœ„ì¹˜'
                        });

                        // 200m ë°˜ê²½ ì› í‘œì‹œ (ì²´í¬ì¸ ê°€ëŠ¥ ë²”ìœ„) (ì‘ì„±ì: ì§„ì›, 2025-12-03 - 100mì—ì„œ 200më¡œ ë³€ê²½)
                        userCircle = new kakao.maps.Circle({
                            center: moveLatLon,
                            radius: 200, // 200ë¯¸í„°
                            strokeWeight: 2,
                            strokeColor: '#4285F4',
                            strokeOpacity: 0.8,
                            strokeStyle: 'solid',
                            fillColor: '#4285F4',
                            fillOpacity: 0.2
                        });
                        userCircle.setMap(map);

                        // ë‚´ ìœ„ì¹˜ ì¸í¬ìœˆë„ìš°
                        const userInfowindow = new kakao.maps.InfoWindow({
                            content: '<div style="padding:8px 12px; font-weight:bold; color:#4285F4;">ğŸ“ ë‚´ ìœ„ì¹˜</div>'
                        });

                        // ì‚¬ìš©ì ë§ˆì»¤ í´ë¦­ ì´ë²¤íŠ¸
                        kakao.maps.event.addListener(userMarker, 'click', function() {
                            // ê¸°ì¡´ ì¸í¬ìœˆë„ìš° ë‹«ê¸°
                            if (currentInfowindow && currentInfowindow !== userInfowindow) {
                                currentInfowindow.close();
                            }

                            if (currentInfowindow === userInfowindow) {
                                userInfowindow.close();
                                currentInfowindow = null;
                            } else {
                                userInfowindow.open(map, userMarker);
                                currentInfowindow = userInfowindow;
                            }
                        });

                        // ì´ˆê¸°ì—ëŠ” ìë™ìœ¼ë¡œ ì—´ê¸°
                        userInfowindow.open(map, userMarker);
                        currentInfowindow = userInfowindow;

                        // ì¢Œí‘œë¥¼ ì£¼ì†Œë¡œ ë³€í™˜ (ì‘ì„±ì: ì§„ì›, 2025-12-03)
                        getAddressFromCoords(lat, lon);

                        // ê°€ê¹Œìš´ ì˜ì—…ì  ì°¾ê¸°
                        findNearestBranch();

                        document.getElementById('btnMyLocation').disabled = false;
                        document.getElementById('btnMyLocation').textContent = 'ë‚´ ìœ„ì¹˜ë¡œ ì´ë™';
                    },
                    (error) => {
                        console.error('ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
                        alert('ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                        document.getElementById('btnMyLocation').disabled = false;
                        document.getElementById('btnMyLocation').textContent = 'ë‚´ ìœ„ì¹˜ë¡œ ì´ë™';
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            }
        }

        // ì˜ì—…ì  ëª©ë¡ ë¡œë“œ (ì‘ì„±ì: ì§„ì›, 2025-11-30)
        function loadBranches() {
            fetch('/busanbank/branch/api/branches')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        branches = data.branches;
                        displayBranchMarkers();
                    } else {
                        console.error('ì˜ì—…ì  ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨');
                    }
                })
                .catch(error => {
                    console.error('ì˜ì—…ì  ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
                });
        }

        // ì˜ì—…ì  ë§ˆì»¤ í‘œì‹œ (ì‘ì„±ì: ì§„ì›, 2025-11-30)
        function displayBranchMarkers() {
            // ì˜ì—…ì  ë§ˆì»¤ ì´ë¯¸ì§€ (ì´ˆë¡ìƒ‰)
            const branchImageSrc = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png';
            const branchImageSize = new kakao.maps.Size(24, 35);
            const branchMarkerImage = new kakao.maps.MarkerImage(branchImageSrc, branchImageSize);

            branches.forEach(branch => {
                if (branch.latitude && branch.longitude) {
                    const position = new kakao.maps.LatLng(branch.latitude, branch.longitude);

                    const marker = new kakao.maps.Marker({
                        map: map,
                        position: position,
                        image: branchMarkerImage,
                        title: branch.branchName
                    });

                    // ì¸í¬ìœˆë„ìš°
                    const infowindow = new kakao.maps.InfoWindow({
                        content: `<div style="padding:10px; min-width:150px;">
                            <strong style="color:#E1545A;">ğŸ¦ ${branch.branchName}</strong><br>
                            <span style="font-size:12px; color:#666;">${branch.address || ''}</span><br>
                            <span style="font-size:11px; color:#999;">ğŸ“ ${branch.tel || '-'}</span>
                        </div>`
                    });

                    // ë§ˆì»¤ í´ë¦­ ì´ë²¤íŠ¸
                    kakao.maps.event.addListener(marker, 'click', function() {
                        // ì´ë¯¸ ì—´ë ¤ìˆëŠ” ì¸í¬ìœˆë„ìš°ê°€ í˜„ì¬ í´ë¦­í•œ ê²ƒê³¼ ê°™ìœ¼ë©´ ë‹«ê¸°
                        if (currentInfowindow === infowindow) {
                            currentInfowindow.close();
                            currentInfowindow = null;
                        } else {
                            // ê¸°ì¡´ì— ì—´ë¦° ì¸í¬ìœˆë„ìš°ê°€ ìˆìœ¼ë©´ ë‹«ê¸°
                            if (currentInfowindow) {
                                currentInfowindow.close();
                            }
                            // ìƒˆë¡œìš´ ì¸í¬ìœˆë„ìš° ì—´ê¸°
                            infowindow.open(map, marker);
                            currentInfowindow = infowindow;
                        }
                    });
                }
            });
        }

        // ê°€ì¥ ê°€ê¹Œìš´ ì˜ì—…ì  ì°¾ê¸° (ì‘ì„±ì: ì§„ì›, 2025-11-30)
        function findNearestBranch() {
            if (!userPosition || branches.length === 0) {
                return;
            }

            let minDistance = Infinity;
            nearestBranch = null;

            branches.forEach(branch => {
                if (branch.latitude && branch.longitude) {
                    const distance = calculateDistance(
                        userPosition.lat,
                        userPosition.lon,
                        branch.latitude,
                        branch.longitude
                    );

                    if (distance < minDistance) {
                        minDistance = distance;
                        nearestBranch = { ...branch, distance };
                    }
                }
            });

            if (nearestBranch) {
                document.getElementById('nearestBranch').textContent = nearestBranch.branchName;
                document.getElementById('distance').textContent = `${Math.round(nearestBranch.distance)}m`;

                // 200m ì´ë‚´ì´ê³  ì˜¤ëŠ˜ ì²´í¬ì¸ ì•ˆí–ˆìœ¼ë©´ ë²„íŠ¼ í™œì„±í™” (ì‘ì„±ì: ì§„ì›, 2025-12-03 - 100mì—ì„œ 200më¡œ ë³€ê²½)
                if (nearestBranch.distance <= 200 && canCheckinToday) {
                    document.getElementById('btnCheckin').disabled = false;
                    document.getElementById('distance').classList.add('success');
                } else {
                    document.getElementById('btnCheckin').disabled = true;
                    if (nearestBranch.distance > 200) {
                        document.getElementById('distance').classList.add('danger');
                    }
                }
            }
        }

        // ê±°ë¦¬ ê³„ì‚° (Haversine formula) (ì‘ì„±ì: ì§„ì›, 2025-11-30)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // ì§€êµ¬ ë°˜ì§€ë¦„ (ë¯¸í„°)
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);

            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }

        // ì¢Œí‘œë¥¼ ì£¼ì†Œë¡œ ë³€í™˜ (ì‘ì„±ì: ì§„ì›, 2025-12-03)
        function getAddressFromCoords(lat, lon) {
            const geocoder = new kakao.maps.services.Geocoder();
            const coord = new kakao.maps.LatLng(lat, lon);

            geocoder.coord2Address(coord.getLng(), coord.getLat(), function(result, status) {
                if (status === kakao.maps.services.Status.OK) {
                    let address = '';

                    // ë„ë¡œëª… ì£¼ì†Œê°€ ìˆìœ¼ë©´ ë„ë¡œëª… ì£¼ì†Œ ì‚¬ìš©
                    if (result[0].road_address) {
                        address = result[0].road_address.address_name;
                    }
                    // ì—†ìœ¼ë©´ ì§€ë²ˆ ì£¼ì†Œ ì‚¬ìš©
                    else if (result[0].address) {
                        address = result[0].address.address_name;
                    }

                    document.getElementById('myAddress').textContent = address || 'ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
                } else {
                    document.getElementById('myAddress').textContent = 'ì£¼ì†Œ ë³€í™˜ ì‹¤íŒ¨';
                    console.error('ì£¼ì†Œ ë³€í™˜ ì‹¤íŒ¨:', status);
                }
            });
        }

        // ì˜¤ëŠ˜ ì²´í¬ì¸ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸ (ì‘ì„±ì: ì§„ì›, 2025-11-30)
        function checkTodayStatus() {
            fetch('/busanbank/branch/api/canCheckin')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        canCheckinToday = data.canCheckin;
                        const statusEl = document.getElementById('todayStatus');

                        if (canCheckinToday) {
                            statusEl.textContent = 'ê°€ëŠ¥';
                            statusEl.classList.add('success');
                        } else {
                            statusEl.textContent = 'ì™„ë£Œ';
                            statusEl.classList.add('danger');
                        }
                    }
                })
                .catch(error => {
                    console.error('ì²´í¬ì¸ ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', error);
                });
        }

        // ì²´í¬ì¸ ì‹¤í–‰ (ì‘ì„±ì: ì§„ì›, 2025-11-30)
        function doCheckin() {
            if (!nearestBranch || !userPosition) {
                alert('ìœ„ì¹˜ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            if (!canCheckinToday) {
                alert('ì˜¤ëŠ˜ì€ ì´ë¯¸ ì²´í¬ì¸ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.');
                return;
            }

            const checkinData = {
                branchId: nearestBranch.branchId,
                latitude: userPosition.lat,
                longitude: userPosition.lon
            };

            fetch('/busanbank/branch/api/checkin', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(checkinData)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        canCheckinToday = false;
                        document.getElementById('todayStatus').textContent = 'ì™„ë£Œ';
                        document.getElementById('todayStatus').classList.remove('success');
                        document.getElementById('todayStatus').classList.add('danger');
                        document.getElementById('btnCheckin').disabled = true;
                        loadHistory();
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error('ì²´í¬ì¸ ì˜¤ë¥˜:', error);
                    alert('ì²´í¬ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                });
        }

        // ì²´í¬ì¸ íˆìŠ¤í† ë¦¬ ë¡œë“œ (ì‘ì„±ì: ì§„ì›, 2025-11-30)
        function loadHistory() {
            fetch('/busanbank/branch/api/history')
                .then(response => response.json())
                .then(data => {
                    const historyList = document.getElementById('historyList');

                    if (data.success) {
                        if (data.history && data.history.length > 0) {
                            historyList.innerHTML = data.history.slice(0, 5).map(item => `
                                <div class="history-item">
                                    <div class="branch-name">${item.branchName}</div>
                                    <div class="date">${item.checkinDate}</div>
                                    <div class="coins">+${item.pointsReceived} í¬ì¸íŠ¸</div>
                                </div>
                            `).join('');
                        } else {
                            historyList.innerHTML = '<div class="loading">ì²´í¬ì¸ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                        }
                    } else {
                        historyList.innerHTML = '<div class="loading">ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
                    }
                })
                .catch(error => {
                    console.error('íˆìŠ¤í† ë¦¬ ë¡œë“œ ì˜¤ë¥˜:', error);
                    document.getElementById('historyList').innerHTML = '<div class="loading">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
                });
        }
    </script>

    <!-- í‘¸í„° -->
    <footer th:replace="~{_footer :: footerFragment(null)}"></footer>
</body>
</html>
