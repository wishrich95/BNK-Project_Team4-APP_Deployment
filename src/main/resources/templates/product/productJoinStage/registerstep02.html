<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>딸깍은행::가입 정보 입력</title>

    <link rel="stylesheet" th:href="@{/css/common/style_common.css}">
    <link rel="stylesheet" th:href="@{/css/common/style_font.css}">
    <link href="//cdn.jsdelivr.net/xeicon/2/xeicon.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/_header.css}">
    <link rel="stylesheet" th:href="@{/css/_footer.css}">
    <link rel="stylesheet" th:href="@{/css/member/AutoLogout.css}">

    <style>
        /* 공통 스타일 */
        :root {
            --red-900: #6A1B9A;
            --red-700: #d3c8ef;
            --red-100: #F3E8FF;
            --white: #ffffff;
            --grey-900: #333333;
            --grey-700: #666666;
            --grey-500: #B9B9B9;
            --grey-300: #DEDEDE;
            --grey-100: #F8F8F8;
            --container: 1200px;
        }
        * { box-sizing: border-box }

        html,body {
            min-width: 1200px;
            height: 100%;
            overflow-x: auto;
        }
        a { color: inherit; text-decoration: none; }
        .container {
            width: var(--container);
            max-width: calc(100% - 40px);
            margin: 0 auto;
        }

        /* 상단 영역 */
        /*.util { background-color: var(--grey-100); border-bottom: 1px solid var(--grey-300); }*/
        /*.util_row { display: flex; align-items: center; height: 50px; font-size: 0.85rem; }*/
        /*.util_logo { height: 20px; margin-right: 20px; }*/
        /*.util_spacer { flex-grow: 1; }*/
        /*.util_row a { margin-left: 20px; }*/
        /*.util_row i { margin-left: 20px; font-size: 1.1rem; }*/

        /*.gnb { background-color: var(--white); border-bottom: 2px solid var(--red-900); }*/
        /*.gnb_row { display: flex; align-items: center; height: 60px; }*/
        /*.menu { display: flex; font-size: 1rem; font-weight: 600; }*/
        /*.menu-item { margin-right: 40px; }*/
        /*.gnb_text a { color: var(--red-900); font-size: 0.9rem; margin-left: 50px; }*/

        /*.gnb_sub { background-color: var(--grey-100); padding: 10px 0; border-bottom: 1px solid var(--grey-300); }*/
        /*.breadcrumb { font-size: 0.9rem; color: var(--grey-700); margin-right: 5px; }*/

        /* 메인 컨텐츠 */
        .content-area {
            min-height: 60vh;
            padding: 50px 0;
            display: flex;
            justify-content: center;
        }

        .join-form-wrap {
            width: 1000px;
        }

        .title-step { color: var(--red-900); font-size: 1.1rem; font-weight: 700; margin-bottom: 10px; }
        .title-main { font-size: 2rem; font-weight: 700; line-height: 1.4; margin-bottom: 40px; color: var(--grey-900); }

        .input-group {
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--grey-300);
        }
        .input-group:last-of-type { border-bottom: none; }

        .group-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--grey-900);
            margin-bottom: 20px;
        }
        .group-subtitle {
            font-size: 1rem;
            color: var(--grey-700);
            margin-bottom: 15px;
            margin-top: 25px;
        }

        /* 인풋, 셀렉트 스타일 */
        select, input[type="text"], input[type="email"], input[type="password"], input[type="number"], .input-box {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--grey-300);
            border-radius: 6px;
            font-size: 1rem;
            color: var(--grey-900);
            -webkit-appearance: none;
            appearance: none;
            background: var(--white);
        }

        input[readonly] {
            background-color: var(--grey-100);
            color: var(--grey-700);
        }

        select {
            background: var(--white) url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="%23666666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>') no-repeat right 15px center;
            background-size: 20px;
        }

        /* 버튼 선택 그룹 */
        .button-select-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        .button-select-group button {
            flex-grow: 1;
            flex-basis: calc(33.333% - 10px);
            padding: 15px 10px;
            border: 1px solid var(--grey-300);
            border-radius: 8px;
            background-color: var(--white);
            color: var(--grey-900);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .button-select-group button.selected {
            border-color: var(--red-900);
            background-color: var(--red-100);
            color: var(--red-900);
        }
        .button-select-group button:hover {
            border-color: var(--red-700);
        }

        /* 금액 직접입력 */
        .amount-input-wrap {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }
        .amount-input-wrap input {
            flex-grow: 1;
            margin-right: 10px;
            text-align: right;
        }
        .amount-input-wrap span {
            font-weight: 600;
            color: var(--grey-700);
        }

        /* 체크박스 */
        .checkbox-item {
            display: flex;
            align-items: center;
            font-size: 1rem;
            color: var(--grey-900);
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid var(--grey-300);
            border-radius: 8px;
        }
        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            appearance: none;
            border: 2px solid var(--grey-500);
            border-radius: 4px;
            cursor: pointer;
        }
        .checkbox-item input[type="checkbox"]:checked {
            border-color: var(--red-900);
            background-color: var(--red-900);
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M4 11.612L9.432 17.044L20 6.476' stroke='%23ffffff' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
            background-size: 12px;
            background-repeat: no-repeat;
            background-position: center;
        }
        .checkbox-item label {
            font-weight: 500;
            cursor: pointer;
        }

        /* 인증 섹션 */
        .verify-section {
            display: none;
            margin-top: 10px;
            padding: 15px;
            background-color: var(--grey-100);
            border-radius: 6px;
        }
        .verify-section.active {
            display: block;
        }

        .form-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .form-row input {
            flex: 1;
        }

        .btn-verify {
            background-color: var(--red-900);
            color: var(--white);
            border: none;
            border-radius: 6px;
            padding: 12px 24px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
            flex-shrink: 0;
        }
        .btn-verify:hover {
            background-color: var(--red-700);
        }
        .btn-verify:disabled {
            background-color: var(--grey-300);
            cursor: not-allowed;
        }

        .verify-result {
            display: inline-block;
            margin-left: 10px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        .verify-result.success { color: green; }
        .verify-result.error { color: red; }

        /* 하단 버튼 */
        .button-area {
            display: flex;
            justify-content: space-between;
            padding-top: 40px;
        }
        .btn-prev {
            width: 30%;
            padding: 15px 0;
            border: 1px solid var(--grey-300);
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--grey-900);
            background-color: var(--white);
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-prev:hover {
            background-color: var(--grey-100);
        }
        .btn-next {
            width: 65%;
            padding: 15px 0;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--white);
            background-color: var(--red-900);
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .btn-next:hover {
            background-color: var(--red-700);
        }
        .btn-next:disabled {
            background-color: var(--grey-300);
            cursor: not-allowed;
        }

        /* 에러 메시지 */
        .error-message {
            color: red;
            font-size: 0.9rem;
            margin-top: 10px;
            display: none;
        }
        .error-message.show {
            display: block;
        }

        /* 알림 정보 텍스트 */
        .alert-info-text {
            font-size: 0.9rem;
            color: var(--grey-700);
            margin-top: 15px;
            line-height: 1.4;
        }
    </style>

    <script th:src="@{/js/gnbDropdown.js}" defer></script>
    <script th:src="@{/js/translate.js}" defer></script>
    <script th:src="@{/js/globalBtn.js}" defer></script>
    <script th:src="@{/js/searchOverlay.js}" defer></script>
    <script th:src="@{/js/member/session-timer.js}" defer></script>
</head>

<body>

<div th:replace="~{_header :: headerFragment}"></div>
<!-- 상단 영역 -->

<!-- 메인 컨텐츠 -->
<section class="container content-area">
    <div class="join-form-wrap">
        <p class="title-step">STEP 2/4</p>
        <h2 class="title-main">가입 정보를 입력해주세요.</h2>

        <form th:action="@{/prod/productjoin/step2}" method="post" id="joinForm">

            <!-- ========== 고객 정보 (자동 입력) ========== -->
            <div class="input-group">
                <h3 class="group-title">고객 정보</h3>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--grey-700);">이름</label>
                    <input type="text" th:value="${userName}" readonly>
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--grey-700);">휴대폰 번호</label>
                    <input type="text" th:value="${userHp}" readonly>
                </div>

                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--grey-700);">이메일</label>
                    <input type="email" th:value="${userEmail}" readonly>
                </div>
            </div>

            <!-- ========== 얼마로 시작할까요? ========== -->
            <div class="input-group">
                <h3 class="group-title">얼마로 시작할까요?</h3>

                <div class="button-select-group" id="amountButtons">
                    <button type="button" data-value="500000">500,000원</button>
                    <button type="button" data-value="1000000">1,000,000원</button>
                    <button type="button" data-value="5000000">5,000,000원</button>
                    <button type="button" data-value="10000000">10,000,000원</button>
                    <button type="button" data-value="50000000">50,000,000원</button>
                    <button type="button" data-value="direct">직접입력</button>
                </div>

                <div class="amount-input-wrap">
                    <input type="number" id="principalAmount"
                           placeholder="최소 50,000원" min="50000" step="10000" disabled>
                    <span>원</span>
                </div>
                <span class="error-message" id="amountError">최소 가입 금액은 5만원입니다.</span>
                <input type="hidden" name="principalAmount" id="principalAmountHidden">
            </div>

            <!-- ========== 언제까지 모아볼까요? ========== -->
            <div class="input-group">
                <h3 class="group-title">언제까지 모아볼까요?</h3>

                <div class="button-select-group" id="termButtons">
                    <button type="button" data-value="6">6개월</button>
                    <button type="button" data-value="12">12개월</button>
                    <button type="button" data-value="24">24개월</button>
                    <button type="button" data-value="36">36개월</button>
                </div>
                <input type="hidden" name="contractTerm" id="contractTerm">
            </div>

            <!-- ========== 계좌 비밀번호 ========== -->
            <div class="input-group">
                <h3 class="group-title">계좌 비밀번호를 설정해주세요.</h3>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--grey-700);">
                        계좌 비밀번호 (4~6자리 숫자) <span style="color: var(--red-900);">*</span>
                    </label>
                    <input type="password" name="accountPassword" id="accountPassword"
                           pattern="[0-9]{4,6}" placeholder="숫자 4~6자리" required>
                </div>

                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--grey-700);">
                        계좌 비밀번호 확인 <span style="color: var(--red-900);">*</span>
                    </label>
                    <input type="password" name="accountPasswordConfirm" id="accountPasswordConfirm"
                           pattern="[0-9]{4,6}" placeholder="비밀번호 다시 입력" required>
                    <span class="error-message" id="passwordError">비밀번호가 일치하지 않습니다.</span>
                </div>
            </div>

            <!-- ========== 권유직원 선택 ========== -->
            <div class="input-group">
                <h3 class="group-title">권유 직원이 있으신가요?</h3>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--grey-700);">
                        지점 선택 <span style="color: var(--red-900);">*</span>
                    </label>
                    <select name="branchId" id="branchSelect" required>
                        <option value="">지점을 선택하세요</option>
                        <option th:each="branch : ${branches}"
                                th:value="${branch.branchId}"
                                th:text="${branch.branchName}">본점</option>
                    </select>
                </div>

                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--grey-700);">
                        직원 선택 <span style="color: var(--red-900);">*</span>
                    </label>
                    <select name="empId" id="empSelect" required disabled>
                        <option value="">먼저 지점을 선택하세요</option>
                    </select>
                </div>
            </div>

            <!-- ========== 만기 알림 설정 ========== -->
            <div class="input-group">
                <h3 class="group-title">만기 알림 어떻게 받을까요?</h3>
                <p style="font-size: 0.95rem; color: var(--grey-700); margin-bottom: 20px;">
                    만기일 알림을 받으실 방법을 선택하고 인증해주세요. (최소 1개 이상 필수)
                </p>

                <!-- SMS 알림 -->
                <div class="checkbox-item">
                    <input type="checkbox" name="notificationSms" value="Y" id="smsNotification">
                    <label for="smsNotification">SMS 알림 받기</label>
                </div>
                <div id="smsVerifySection" class="verify-section">
                    <div class="form-row">
                        <input type="text" name="notificationHp" id="notificationHp"
                               th:value="${userHp}" placeholder="휴대폰 번호 (- 포함)">
                        <button type="button" class="btn-verify" id="btnSendSms">인증번호 발송</button>
                    </div>
                    <div class="form-row" id="smsCodeSection" style="display:none; margin-top:10px;">
                        <input type="text" id="smsCode" placeholder="인증번호 6자리 입력">
                        <button type="button" class="btn-verify" id="btnVerifySms">확인</button>
                        <span class="verify-result" id="smsVerifyResult"></span>
                    </div>
                    <input type="hidden" name="smsVerified" id="smsVerified" value="false">
                </div>

                <!-- 이메일 알림 -->
                <div class="checkbox-item">
                    <input type="checkbox" name="notificationEmail" value="Y" id="emailNotification">
                    <label for="emailNotification">이메일 알림 받기</label>
                </div>
                <div id="emailVerifySection" class="verify-section">
                    <div class="form-row">
                        <input type="email" name="notificationEmailAddr" id="notificationEmailAddr"
                               th:value="${userEmail}" placeholder="이메일 주소">
                        <button type="button" class="btn-verify" id="btnSendEmail">인증번호 발송</button>
                    </div>
                    <div class="form-row" id="emailCodeSection" style="display:none; margin-top:10px;">
                        <input type="text" id="emailCode" placeholder="인증번호 6자리 입력">
                        <button type="button" class="btn-verify" id="btnVerifyEmail">확인</button>
                        <span class="verify-result" id="emailVerifyResult"></span>
                    </div>
                    <input type="hidden" name="emailVerified" id="emailVerified" value="false">
                </div>

                <div class="alert-info-text">
                    <ul style="padding-left: 20px;">
                        <li>만기일 전에 선택하신 방법으로 알림을 보내드립니다.</li>
                        <li>인증을 완료해야 다음 단계로 진행할 수 있습니다.</li>
                    </ul>
                </div>
            </div>

            <!-- ========== 하단 버튼 ========== -->
            <div class="button-area">
                <button type="button" class="btn-prev" onclick="history.back()">이전</button>
                <button type="submit" class="btn-next" id="btnSubmit" disabled>다음 단계로</button>
            </div>
        </form>
    </div>
</section>

<!-- Footer -->
<div th:replace="~{_footer :: footerFragment(${appInfo})}"></div>

<!-- JavaScript -->
<script th:inline="javascript">
    /*<![CDATA[*/
    // Thymeleaf 변수
    const contextPath = /*[[@{/}]]*/ '/busanbank/';

    // 로그인 체크
    const needLogin = /*[[${needLogin}]]*/ false;
    const redirectUrl = /*[[${redirectUrl}]]*/ '';

    if (needLogin) {
        alert('로그인이 필요한 서비스입니다.\n로그인 페이지로 이동합니다.');
        window.location.href = contextPath + 'member/login?redirect_uri=' + encodeURIComponent(redirectUrl);
    }

    // 전역 변수
    let selectedAmount = 0;
    let selectedTerm = 0;
    let amountValid = false;
    let termValid = false;
    let passwordValid = false;
    let branchValid = false;
    let empValid = false;
    let notificationValid = false;

    // ========== 페이지 로드 시 초기화 ==========
    window.addEventListener('load', function() {
        console.log('✅ 페이지 로드 완료');

        // 모든 버튼 강제 활성화
        document.querySelectorAll('.button-select-group button').forEach(btn => {
            btn.disabled = false;
            btn.style.pointerEvents = 'auto';
            btn.style.opacity = '1';
            btn.style.cursor = 'pointer';
        });

        console.log('✅ 버튼 활성화 완료');
    });

    // ========== 금액 선택 ==========
    document.getElementById('amountButtons').addEventListener('click', function(e) {
        if (e.target.tagName === 'BUTTON') {
            console.log('금액 버튼 클릭:', e.target.dataset.value);

            // 선택 해제
            this.querySelectorAll('button').forEach(btn => btn.classList.remove('selected'));

            // 선택
            e.target.classList.add('selected');

            const value = e.target.dataset.value;
            const amountInput = document.getElementById('principalAmount');
            const hiddenInput = document.getElementById('principalAmountHidden'); // ✅ 추가

            if (value === 'direct') {
                amountInput.disabled = false;
                amountInput.value = '';
                hiddenInput.value = ''; // ✅ 추가
                amountInput.focus();
                amountValid = false;
            } else {
                amountInput.disabled = true;
                amountInput.value = value;
                hiddenInput.value = value; // ✅ 값 설정!
                selectedAmount = parseInt(value);
                amountValid = true;
            }

            checkFormValid();
        }
    });

    // 직접 입력
    document.getElementById('principalAmount').addEventListener('input', function() {
        const value = parseInt(this.value);
        const hiddenInput = document.getElementById('principalAmountHidden'); // ✅ 추가

        if (value >= 500000) {
            selectedAmount = value;
            hiddenInput.value = value; // ✅ 값 설정!
            amountValid = true;
            document.getElementById('amountError').classList.remove('show');
        } else {
            hiddenInput.value = ''; // ✅ 유효하지 않으면 빈 값
            amountValid = false;
            document.getElementById('amountError').classList.add('show');
        }
        checkFormValid();
    });

    // ========== 가입 기간 선택 ==========
    document.getElementById('termButtons').addEventListener('click', function(e) {
        if (e.target.tagName === 'BUTTON') {
            console.log('기간 버튼 클릭:', e.target.dataset.value);

            // 선택 해제
            this.querySelectorAll('button').forEach(btn => btn.classList.remove('selected'));

            // 선택
            e.target.classList.add('selected');

            selectedTerm = parseInt(e.target.dataset.value);
            document.getElementById('contractTerm').value = selectedTerm;
            termValid = true;

            checkFormValid();
        }
    });

    // ========== 비밀번호 검증 ==========
    function checkPassword() {
        const pw = document.getElementById('accountPassword').value;
        const pwConfirm = document.getElementById('accountPasswordConfirm').value;

        if (pw && pwConfirm) {
            if (pw === pwConfirm && /^[0-9]{4,6}$/.test(pw)) {
                passwordValid = true;
                document.getElementById('passwordError').classList.remove('show');
            } else {
                passwordValid = false;
                document.getElementById('passwordError').classList.add('show');
            }
        } else {
            passwordValid = false;
        }
        checkFormValid();
    }

    document.getElementById('accountPassword').addEventListener('input', checkPassword);
    document.getElementById('accountPasswordConfirm').addEventListener('input', checkPassword);

    // ========== 지점/직원 선택 ==========
    document.getElementById('branchSelect').addEventListener('change', function() {
        const branchId = this.value;
        const empSelect = document.getElementById('empSelect');
        branchValid = !!branchId;

        if (!branchId) {
            empSelect.innerHTML = '<option value="">먼저 지점을 선택하세요</option>';
            empSelect.disabled = true;
            empValid = false;
            checkFormValid();
            return;
        }

        fetch(contextPath + `api/branch/${branchId}/employees`)
            .then(response => response.json())
            .then(employees => {
                empSelect.innerHTML = '<option value="">직원을 선택하세요</option>';
                employees.forEach(emp => {
                    empSelect.innerHTML += `<option value="${emp.empId}">${emp.empName} ${emp.position}</option>`;
                });
                empSelect.disabled = false;
            })
            .catch(error => {
                console.error('직원 목록 조회 실패:', error);
                alert('직원 목록을 불러오는데 실패했습니다.');
            });
    });

    document.getElementById('empSelect').addEventListener('change', function() {
        empValid = !!this.value;
        checkFormValid();
    });

    // ========== SMS 알림 ==========
    document.getElementById('smsNotification').addEventListener('change', function() {
        document.getElementById('smsVerifySection').classList.toggle('active', this.checked);
        checkNotification();
    });

    document.getElementById('btnSendSms').addEventListener('click', function() {
        const hp = document.getElementById('notificationHp').value;
        if (!hp) {
            alert('휴대폰 번호를 입력하세요.');
            return;
        }

        this.disabled = true;
        this.textContent = '발송 중...';

        fetch(contextPath + 'member/hp/send', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ hp: hp, mode: 'notification' })
        })
            .then(response => response.text())
            .then(message => {
                alert(message);
                document.getElementById('smsCodeSection').style.display = 'flex';
                this.textContent = '재발송';
                this.disabled = false;
            })
            .catch(error => {
                alert('SMS 발송에 실패했습니다.');
                this.textContent = '인증번호 발송';
                this.disabled = false;
            });
    });

    document.getElementById('btnVerifySms').addEventListener('click', function() {
        const code = document.getElementById('smsCode').value;
        if (!code) {
            alert('인증번호를 입력하세요.');
            return;
        }

        fetch(contextPath + 'member/hp/verify', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ code: code })
        })
            .then(response => response.json())
            .then(data => {
                const resultSpan = document.getElementById('smsVerifyResult');
                if (data.verified) {
                    resultSpan.textContent = '✅ 인증 완료';
                    resultSpan.className = 'verify-result success';
                    document.getElementById('smsVerified').value = 'true';
                    document.getElementById('smsCode').disabled = true;
                    this.disabled = true;
                    checkNotification();
                } else {
                    resultSpan.textContent = '❌ 인증 실패';
                    resultSpan.className = 'verify-result error';
                    alert('인증번호가 일치하지 않습니다.');
                }
            });
    });

    // ========== 이메일 알림 ==========
    document.getElementById('emailNotification').addEventListener('change', function() {
        document.getElementById('emailVerifySection').classList.toggle('active', this.checked);
        checkNotification();
    });

    document.getElementById('btnSendEmail').addEventListener('click', function() {
        const email = document.getElementById('notificationEmailAddr').value;
        if (!email) {
            alert('이메일 주소를 입력하세요.');
            return;
        }

        this.disabled = true;
        this.textContent = '발송 중...';

        fetch(contextPath + 'member/email/send', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ email: email })
        })
            .then(response => response.text())
            .then(message => {
                alert(message);
                document.getElementById('emailCodeSection').style.display = 'flex';
                this.textContent = '재발송';
                this.disabled = false;
            })
            .catch(error => {
                alert('이메일 발송에 실패했습니다.');
                this.textContent = '인증번호 발송';
                this.disabled = false;
            });
    });

    document.getElementById('btnVerifyEmail').addEventListener('click', function() {
        const code = document.getElementById('emailCode').value;
        if (!code) {
            alert('인증번호를 입력하세요.');
            return;
        }

        fetch(contextPath + 'member/email/verify', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ code: code })
        })
            .then(response => response.json())
            .then(data => {
                const resultSpan = document.getElementById('emailVerifyResult');
                if (data.verified) {
                    resultSpan.textContent = '✅ 인증 완료';
                    resultSpan.className = 'verify-result success';
                    document.getElementById('emailVerified').value = 'true';
                    document.getElementById('emailCode').disabled = true;
                    this.disabled = true;
                    checkNotification();
                } else {
                    resultSpan.textContent = '❌ 인증 실패';
                    resultSpan.className = 'verify-result error';
                    alert('인증번호가 일치하지 않습니다.');
                }
            });
    });

    // ========== 알림 설정 검증 ==========
    function checkNotification() {
        const smsChecked = document.getElementById('smsNotification').checked;
        const emailChecked = document.getElementById('emailNotification').checked;
        const smsVerified = document.getElementById('smsVerified').value === 'true';
        const emailVerified = document.getElementById('emailVerified').value === 'true';

        if (!smsChecked && !emailChecked) {
            notificationValid = false;
        } else if (smsChecked && !smsVerified) {
            notificationValid = false;
        } else if (emailChecked && !emailVerified) {
            notificationValid = false;
        } else {
            notificationValid = true;
        }

        checkFormValid();
    }

    // ========== 전체 폼 검증 ==========
    function checkFormValid() {
        const allValid = amountValid && termValid && passwordValid && branchValid && empValid && notificationValid;

        console.log('폼 검증:', {
            amountValid,
            termValid,
            passwordValid,
            branchValid,
            empValid,
            notificationValid,
            allValid
        });

        document.getElementById('btnSubmit').disabled = !allValid;
    }

    // ==========================
    // 계약기간 버튼 선택 이벤트
    // ==========================
    document.querySelectorAll("#termButtons button").forEach(btn => {
        btn.addEventListener("click", () => {

            // active 모두 제거
            document.querySelectorAll("#termButtons button")
                .forEach(b => b.classList.remove("active"));

            // 선택한 버튼 active 추가
            btn.classList.add("active");

            // hidden input 에 실제 값 설정
            document.getElementById("contractTerm").value = btn.dataset.value;

            console.log("선택된 계약기간:", btn.dataset.value);
        });
    });

    // ========== 폼 제출 ==========
    document.getElementById('joinForm').addEventListener('submit', function(e) {
        e.preventDefault();

        if (document.getElementById('btnSubmit').disabled) {
            alert('모든 필수 항목을 입력해주세요.');
            return;
        }

        console.log('✅ 폼 제출');
        document.getElementById('btnSubmit').disabled = true;
        document.getElementById('btnSubmit').textContent = '처리 중...';
        this.submit();
    });

    // 초기 검증
    checkFormValid();
    /*]]>*/
</script>
</body>
</html>