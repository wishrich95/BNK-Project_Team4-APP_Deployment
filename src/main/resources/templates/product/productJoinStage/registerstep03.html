<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>ë”¸ê¹ì€í–‰::ì…ë ¥ ì •ë³´ í™•ì¸</title>

    <link rel="stylesheet" th:href="@{/css/common/style_common.css}">
    <link rel="stylesheet" th:href="@{/css/common/style_font.css}">
    <link href="//cdn.jsdelivr.net/xeicon/2/xeicon.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/_header.css}">
    <link rel="stylesheet" th:href="@{/css/_footer.css}">
    <link rel="stylesheet" th:href="@{/css/member/AutoLogout.css}">

    <style>
        :root {
            --red-900: #6A1B9A;
            --red-700: #d3c8ef;
            --red-100: #F3E8FF;
            --white: #ffffff;
            --grey-900: #333333;
            --grey-700: #666666;
            --grey-500: #B9B9B9;
            --grey-400: #B0B0B0;
            --grey-300: #DEDEDE;
            --grey-100: #F8F8F8;
            --container: 1200px;
        }
        * { box-sizing: border-box }

        html,body {
            min-width: 1200px;
            height: 100%;
            overflow-x: auto;
        }
        a { color: inherit; text-decoration: none; }
        .container {
            width: var(--container);
            max-width: calc(100% - 40px);
            margin: 0 auto;
        }

        /* ìƒë‹¨ ì˜ì—­ ìŠ¤íƒ€ì¼ */

        .content-area {
            min-height: 60vh;
            padding: 50px 0;
            display: flex;
            justify-content: center;
        }

        .review-wrap {
            width: 800px;
        }

        .title-step { color: var(--red-900); font-size: 1.1rem; font-weight: 700; margin-bottom: 10px; }
        .title-main { font-size: 2rem; font-weight: 700; line-height: 1.4; margin-bottom: 40px; color: var(--grey-900); }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--grey-900);
            margin-bottom: 20px;
            padding-top: 40px;
            border-top: 1px solid var(--grey-300);
        }
        .section-title:first-of-type { border-top: none; padding-top: 0; }

        /* ì…ë ¥ ì •ë³´ í™•ì¸ í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .info-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 1rem;
            margin-bottom: 30px;
        }
        .info-table th, .info-table td {
            padding: 15px 0;
            border-bottom: 1px solid var(--grey-300);
        }
        .info-table th {
            text-align: left;
            width: 30%;
            color: var(--grey-700);
            font-weight: 500;
        }
        .info-table td {
            text-align: right;
            font-weight: 600;
            color: var(--grey-900);
        }
        .info-table td.highlight {
            color: var(--red-900);
            font-weight: 700;
        }
        .info-table .text-link {
            font-size: 0.9rem;
            color: var(--red-900);
            cursor: pointer;
            margin-left: 10px;
        }

        /* ì´í•´ í™•ì¸ ê·¸ë£¹ ìŠ¤íƒ€ì¼ (ë©”ì¸ í˜ì´ì§€) */
        .check-group {
            margin-bottom: 40px;
            padding: 20px;
            border: 1px solid var(--grey-300);
            border-radius: 8px;
        }
        .check-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px dashed var(--grey-300);
        }
        .check-item:last-of-type { border-bottom: none; }
        .check-item-label {
            font-size: 1rem;
            color: var(--grey-900);
            font-weight: 600;
        }
        .check-item-action {
            display: flex;
            gap: 10px;
        }

        /* ë©”ì¸ í˜ì´ì§€ í† ê¸€ ë²„íŠ¼ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        .check-group .toggle-btn {
            padding: 8px 15px;
            border: 1px solid var(--grey-500);
            border-radius: 5px;
            background-color: var(--white);
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--grey-700);
            transition: all 0.2s;
        }
        .check-group .toggle-btn.selected {
            border-color: var(--red-900);
            background-color: var(--red-100);
            color: var(--red-900);
        }

        /* ì „ìì„œëª… ë° ìµœì¢… ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .sign-area {
            text-align: center;
            padding: 40px 0;
        }
        .sign-button {
            padding: 15px 30px;
            background-color: var(--grey-900);
            color: var(--white);
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            margin-bottom: 20px;
        }
        .sign-info {
            font-size: 0.9rem;
            color: var(--grey-700);
        }

        /* í•˜ë‹¨ ë²„íŠ¼ ì˜ì—­ */
        .button-area {
            display: flex;
            justify-content: space-between;
            padding-top: 40px;
        }
        .btn-prev {
            width: 30%;
            padding: 15px 0;
            border: 1px solid var(--grey-300);
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--grey-900);
            background-color: var(--white);
            cursor: pointer;
        }
        .btn-next {
            width: 65%;
            padding: 15px 0;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--white);
            background-color: var(--red-900);
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .btn-next:disabled {
            background-color: var(--grey-300);
            cursor: not-allowed;
        }

        /* ëª¨ë‹¬ íŒì—… ìŠ¤íƒ€ì¼ */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background-color: var(--white); margin: auto; padding: 30px; border-radius: 10px; width: 90%; max-width: 750px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--grey-300); padding-bottom: 15px; margin-bottom: 20px; }
        .modal-header h2 { font-size: 1.5rem; font-weight: 700; color: var(--grey-900); }
        .close-btn { color: var(--grey-500); font-size: 2rem; font-weight: bold; cursor: pointer; transition: color 0.2s; }
        .modal-body { max-height: 85vh; overflow-y: auto; padding-right: 15px; line-height: 1.6; font-size: 0.95rem; color: var(--grey-700); }
        .modal-body strong { color: var(--red-900); font-weight: 700; }

        /* ì „ìì„œëª… ëª¨ë‹¬ ë³¸ë¬¸ ìŠ¤íƒ€ì¼ */
        .contract-preview {
            border: 1px solid var(--grey-300);
            padding: 15px;
            background-color: var(--grey-100);
            max-height: 55vh;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        .contract-preview h3 { font-size: 1.1rem; color: var(--grey-900); margin-bottom: 10px; }
        .contract-content { font-size: 0.85rem; color: var(--grey-700); line-height: 1.4; white-space: pre-wrap; }
        .confirm-question { font-size: 1.1rem; color: var(--grey-900); font-weight: 600; margin-bottom: 15px; }

        .modal-footer { padding-top: 20px; text-align: center; display: flex; justify-content: space-between; gap: 10px; }
        .modal-footer button { padding: 12px 25px; border: none; border-radius: 6px; font-size: 1rem; font-weight: 700; cursor: pointer; flex-grow: 1; }
        .modal-footer .btn-secondary { background-color: var(--grey-300); color: var(--grey-900); }
        .modal-footer .btn-primary { background-color: var(--red-900); color: var(--white); }
        .modal-footer .btn-pdf {
            background-color: var(--white);
            color: var(--red-900);
            border: 2px solid var(--red-900);
            transition: background-color 0.3s;
        }
        .modal-footer .btn-pdf:hover {
            background-color: var(--grey-100);
        }

        /* ëª¨ë‹¬ ë‚´ ìµœì¢… ë™ì˜ í† ê¸€ ë²„íŠ¼ ìŠ¤íƒ€ì¼ (ê³„ì•½ì„œ í•˜ë‹¨) */
        #modalAgreement {
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        #modalAgreement .toggle-btn {
            padding: 10px 20px;
            border: 1px solid var(--grey-400);
            background-color: var(--white);
            color: var(--grey-700);
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.2s;
            flex-grow: 1;
            font-weight: 500;
        }
        #modalAgreement .toggle-btn.selected {
            border-color: var(--red-900);
            background-color: var(--red-100);
            color: var(--red-900);
            font-weight: 700;
            box-shadow: 0 0 0 1px var(--red-900) inset;
        }

        /* âœ… ê³„ì•½ì„œ ë‚´ ì²´í¬ë°•ìŠ¤ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        .contract-checkbox-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin: 15px 0;
        }
        .contract-checkbox-item {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        .contract-checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 8px;
            cursor: pointer;
            accent-color: var(--red-900);
        }
        .contract-checkbox-item label {
            cursor: pointer;
            font-size: 0.95rem;
            color: var(--grey-900);
        }
    </style>

    <script th:src="@{/js/gnbDropdown.js}" defer></script>
    <script th:src="@{/js/translate.js}" defer></script>
    <script th:src="@{/js/globalBtn.js}" defer></script>
    <script th:src="@{/js/searchOverlay.js}" defer></script>
    <script th:src="@{/js/member/session-timer.js}" defer></script>
</head>

<body>

<div th:replace="~{_header :: headerFragment}"></div>


<section class="container content-area">
    <div class="review-wrap">
        <p class="title-step">STEP 3/4</p>
        <h2 class="title-main">ì…ë ¥í•˜ì‹  ì •ë³´ì™€ ê³„ì•½ ë‚´ìš©ì„ í™•ì¸í•´ì£¼ì„¸ìš”.</h2>

        <form th:action="@{/prod/productjoin/step3}" method="post" id="reviewForm">

            <!-- âœ… hidden inputs ì¶”ê°€ (ëª¨ë“  ë°ì´í„° ì „ë‹¬) -->
            <input type="hidden" name="productNo" th:value="${joinRequest.productNo}">
            <input type="hidden" name="userId" th:value="${joinRequest.userId}">
            <input type="hidden" name="principalAmount" th:value="${joinRequest.principalAmount}">
            <input type="hidden" name="contractTerm" th:value="${joinRequest.contractTerm}">
            <input type="hidden" name="startDate" th:value="${joinRequest.startDate}">
            <input type="hidden" name="expectedEndDate" th:value="${joinRequest.expectedEndDate}">
            <input type="hidden" name="applyRate" th:value="${joinRequest.applyRate}">
            <input type="hidden" name="baseRate" th:value="${joinRequest.baseRate}">
            <input type="hidden" name="earlyTerminateRate" th:value="${joinRequest.earlyTerminateRate}">
            <input type="hidden" name="productName" th:value="${joinRequest.productName}">
            <input type="hidden" name="productType" th:value="${joinRequest.productType}">
            <input type="hidden" name="accountPassword" th:value="${joinRequest.accountPassword}">
            <input type="hidden" name="branchId" th:value="${joinRequest.branchId}">
            <input type="hidden" name="empId" th:value="${joinRequest.empId}">
            <input type="hidden" name="notificationSms" th:value="${joinRequest.notificationSms}">
            <input type="hidden" name="notificationEmail" th:value="${joinRequest.notificationEmail}">

            <input type="hidden" name="notificationHp" th:value="${joinRequest.notificationHp}">
            <input type="hidden" name="notificationEmailAddr" th:value="${joinRequest.notificationEmailAddr}">
            <input type="hidden" name="userPoints" th:value="${joinRequest.userPoints}">
            <!-- âœ… pointBonusRateëŠ” ë¼ì¸ 518ì—ë§Œ ìˆìŒ (JavaScriptë¡œ ì—…ë°ì´íŠ¸ë¨) -->

            <!-- Hidden inputs - í¬ì¸íŠ¸/ê¸ˆë¦¬ ê´€ë ¨ ì´ˆê¸°ê°’ -->
            <input type="hidden" name="usedPoints" id="usedPoints" value="0">
            <input type="hidden" name="pointBonusRate" id="pointBonusRateInput" value="0.00">
            <input type="hidden" name="applyRate" id="applyRateInput" th:value="${joinRequest.applyRate}">



            <h3 class="section-title">ì…ë ¥í•˜ì‹  ì •ë³´ í™•ì¸</h3>
            <table class="info-table">
                <tr>
                    <th>ê°€ì… ê¸ˆì•¡</th>
                    <td th:text="${#numbers.formatInteger(joinRequest.principalAmount, 0, 'COMMA')} + 'ì›'">500,000ì›</td>
                </tr>
                <tr>
                    <th>ê°€ì… ê¸°ê°„</th>
                    <td th:text="${joinRequest.contractTerm} + 'ê°œì›” (' + ${joinRequest.expectedEndDate} + ' ë§Œê¸°)'">
                        12ê°œì›” (2026-11-21 ë§Œê¸°)
                    </td>
                </tr>
                <tr>
                    <th>ê°€ì…ì¼</th>
                    <td th:text="${joinRequest.startDate}">2025-11-21</td>
                </tr>
                <tr>
                    <th>ê³¼ì„¸ ìœ í˜•</th>
                    <td>ì¼ë°˜ê³¼ì„¸</td>
                </tr>
                <tr>
                    <th>ì´ì ì§€ê¸‰ ë°©ë²•</th>
                    <td>ë§Œê¸° ì¼ì‹œ ì§€ê¸‰-ë‹¨ë¦¬ì‹</td>
                </tr>

                <!-- âœ… í¬ì¸íŠ¸ ì •ë³´ ì¶”ê°€ -->
                <tr style="background-color: #FFF9E6; border-left: 4px solid #FFB800;">
                    <th>ë³´ìœ  í¬ì¸íŠ¸</th>
                    <td>
                        <strong th:text="${userPoints} + ' P'">5000 P</strong>
                        <br>
                        <small style="color: #FFB800; font-size: 0.9rem; font-weight: 600;">
                            <!-- âœ… ë³´ìœ  í¬ì¸íŠ¸ë¡œ ë°›ì„ ìˆ˜ ìˆëŠ” ìµœëŒ€ ê¸ˆë¦¬ í‘œì‹œ -->
                            (100ì ë‹¹ 0.1% ê¸ˆë¦¬ ìš°ëŒ€)
                            <span th:text="'ì „ì²´ ì‚¬ìš© ì‹œ +' + ${#numbers.formatDecimal((userPoints / 100) * 0.1, 1, 1)} + '% ì¶”ê°€'">ì „ì²´ ì‚¬ìš© ì‹œ +5.0% ì¶”ê°€</span>
                        </small>
                    </td>
                </tr>

                <tr>
                    <th>ê¸°ë³¸ ì´ìœ¨</th>
                    <td th:text="'ì—° ' + ${joinRequest.baseRate} + '%'">ì—° 3.50%</td>
                </tr>

                <!-- âœ… í¬ì¸íŠ¸ ê¸ˆë¦¬ í‘œì‹œ -->
                <tr style="background-color: #FFF9E6;">
                    <th>í¬ì¸íŠ¸ ì¶”ê°€ ê¸ˆë¦¬</th>
                    <td class="highlight" style="color: #FFB800; font-weight: 700;">
                        <span id="displayPointBonus" th:text="'+ ' + ${joinRequest.pointBonusRate != null ? joinRequest.pointBonusRate : 0} + '%'">+ 0.00%</span>
                    </td>
                </tr>

                <!-- âœ… ìµœì¢… ì ìš© ê¸ˆë¦¬ -->
                <tr style="background-color: #FAE5E6;">
                    <th>ìµœì¢… ì ìš© ì´ìœ¨</th>
                    <td class="highlight" style="color: var(--red-900); font-size: 1.2rem; font-weight: 700;">
                        <span id="displayFinalRate" th:text="'ì—° ' + ${joinRequest.applyRate != null ? joinRequest.applyRate : joinRequest.baseRate} + '%'">ì—° 3.50%</span>
                        <br>
                        <small style="color: #666; font-size: 0.85rem;">
                            (ê¸°ë³¸ <span th:text="${joinRequest.baseRate} + '%'">3.50%</span> +
                            í¬ì¸íŠ¸ <span id="displayPointBonusSmall" th:text="${joinRequest.pointBonusRate != null ? joinRequest.pointBonusRate : 0} + '%'">0.00%</span>)
                        </small>
                    </td>
                </tr>

                <!-- âœ… ì˜ˆìƒ ì´ì í‘œì‹œ -->
                <tr>
                    <th>ì˜ˆìƒ ì„¸ì „ ì´ì</th>
                    <td th:text="${#numbers.formatInteger(joinRequest.expectedInterest, 0, 'COMMA')} + 'ì›'">
                        29,500ì›
                    </td>
                </tr>

                <!-- âœ… ì˜ˆìƒ ìˆ˜ë ¹ì•¡ í‘œì‹œ -->
                <tr style="background-color: #F0F0F0;">
                    <th>ì˜ˆìƒ ìˆ˜ë ¹ì•¡</th>
                    <td style="font-size: 1.1rem; font-weight: 700; color: var(--red-900);">
                <span th:text="${#numbers.formatInteger(joinRequest.expectedTotal, 0, 'COMMA')} + 'ì›'">
                    529,500ì›
                </span>
                    </td>
                </tr>
            </table>


            <!-- 1. í¬ì¸íŠ¸ ì„ íƒ ì„¹ì…˜ ì¶”ê°€ (info-table ì•„ë˜) -->
            <h3 class="section-title">ğŸ í¬ì¸íŠ¸ ê¸ˆë¦¬ ìš°ëŒ€ ì„ íƒ</h3>
            <div class="point-selection-box" style="border: 2px solid #FFB800; border-radius: 12px; padding: 30px; background: linear-gradient(135deg, #FFF9E6 0%, #FFFBF0 100%); margin-bottom: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>
                        <h4 style="font-size: 1.2rem; font-weight: 700; color: #333; margin-bottom: 10px;">ë³´ìœ  í¬ì¸íŠ¸</h4>
                        <p style="font-size: 2rem; font-weight: 700; color: #FFB800;" id="totalPoints" th:text="${userPoints} + ' P'">1,200 P</p>
                    </div>
                    <div style="text-align: right;">
                        <p style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">í˜„ì¬ ì ìš© ê¸ˆë¦¬</p>
                        <p style="font-size: 1.5rem; font-weight: 700; color: var(--red-900);" id="currentApplyRate" th:text="'ì—° ' + ${joinRequest.applyRate} + '%'">ì—° 4.70%</p>
                    </div>
                </div>

                <div style="background: white; border-radius: 8px; padding: 20px;">
                    <label style="display: block; font-weight: 600; color: #333; margin-bottom: 15px;">
                        ì‚¬ìš©í•  í¬ì¸íŠ¸ ì„ íƒ (100ì  = 0.1% ê¸ˆë¦¬ ì¶”ê°€)
                    </label>

                    <!-- ìŠ¬ë¼ì´ë” -->
                    <input type="range"
                           id="pointSlider"
                           name="pointSlider"
                           min="0"
                           step="100"
                           th:attr="max=${userPoints}"
                           value="0"
                           style="width: 100%; height: 8px; border-radius: 5px; background: #ddd; outline: none; margin-bottom: 15px;">



                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div>
                            <span style="font-size: 0.9rem; color: #666;">ì„ íƒí•œ í¬ì¸íŠ¸: </span>
                            <span style="font-size: 1.3rem; font-weight: 700; color: #FFB800;" id="selectedPoints">0</span>
                            <span style="font-size: 0.9rem; color: #666;"> P</span>
                        </div>
                        <div>
                            <span style="font-size: 0.9rem; color: #666;">ì¶”ê°€ ê¸ˆë¦¬: </span>
                            <span style="font-size: 1.3rem; font-weight: 700; color: var(--red-900);" id="pointBonusRate">0.00</span>
                            <span style="font-size: 0.9rem; color: #666;">%</span>
                        </div>
                    </div>

                    <!-- ë¹ ë¥¸ ì„ íƒ ë²„íŠ¼ -->
                    <!--                    <div style="display: flex; gap: 10px; margin-top: 15px;">-->
                    <!--                        <button type="button" onclick="selectPoints(0)" style="flex: 1; padding: 10px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer; font-weight: 600;">ì‚¬ìš© ì•ˆ í•¨</button>-->
                    <!--                        <button type="button" onclick="selectPoints(500)" style="flex: 1; padding: 10px; border: 1px solid #FFB800; background: #FFF9E6; color: #FFB800; border-radius: 6px; cursor: pointer; font-weight: 600;">500P</button>-->
                    <!--                        <button type="button" onclick="selectPoints(1000)" style="flex: 1; padding: 10px; border: 1px solid #FFB800; background: #FFF9E6; color: #FFB800; border-radius: 6px; cursor: pointer; font-weight: 600;">1,000P</button>-->
                    <!--                        <button type="button" onclick="selectPointsMax()" style="flex: 1; padding: 10px; border: 1px solid #FFB800; background: #FFB800; color: white; border-radius: 6px; cursor: pointer; font-weight: 600;">ì „ì²´ ì‚¬ìš©</button>-->
                    <!--                    </div>-->

                    <!-- ì˜ˆìƒ ê¸ˆë¦¬ í‘œì‹œ -->
                    <div style="margin-top: 20px; padding: 15px; background: #FAE5E6; border-radius: 8px; text-align: center;">
                        <p style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">í¬ì¸íŠ¸ ì ìš© í›„ ìµœì¢… ê¸ˆë¦¬</p>
                        <p style="font-size: 2rem; font-weight: 700; color: var(--red-900);" id="finalRate">ì—° 4.70%</p>
                        <p style="font-size: 0.85rem; color: #666; margin-top: 5px;">
                            (ê¸°ë³¸ <span id="baseRateDisplay" th:text="${joinRequest.baseRate} + '%'">3.50%</span> +
                            í¬ì¸íŠ¸ <span id="bonusRateDisplay">0.00%</span>)
                        </p>
                    </div>
                </div>
            </div>

            <!-- ğŸ ì¿ í° ì„ íƒ ì„¹ì…˜ -->
            <div th:if="${availableCoupons != null and !availableCoupons.isEmpty()}">
                <h3 class="section-title">ğŸ ê²Œì„ ì¿ í° ìš°ëŒ€ê¸ˆë¦¬ ì„ íƒ</h3>
                <div style="border: 2px solid #E1545A; border-radius: 12px; padding: 30px; background: linear-gradient(135deg, #FAE5E6 0%, #FFF0F0 100%); margin-bottom: 30px;">
                    <div style="background: white; border-radius: 8px; padding: 20px;">
                        <div style="display: grid; gap: 15px;">
                            <div class="coupon-card" onclick="selectCoupon(null, 0)" style="border: 2px solid #E1545A; border-radius: 10px; padding: 20px; cursor: pointer; background: linear-gradient(135deg, #FAE5E6 0%, #FFF0F0 100%);">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <p style="font-weight: 700; font-size: 1.1rem; color: #333; margin-bottom: 5px;">ì¿ í° ì‚¬ìš© ì•ˆ í•¨</p>
                                        <p style="font-size: 0.9rem; color: #666;">ê¸°ë³¸ ê¸ˆë¦¬ë¡œ ì§„í–‰í•©ë‹ˆë‹¤</p>
                                    </div>
                                    <div><span style="font-size: 1.3rem; font-weight: 700; color: #999;">+0%</span></div>
                                </div>
                            </div>
                            <div th:each="coupon : ${availableCoupons}" class="coupon-card" th:onclick="'selectCoupon(' + ${coupon.userCouponId} + ', ' + ${coupon.rateIncrease} + ')'" style="border: 2px solid #ddd; border-radius: 10px; padding: 20px; cursor: pointer; background: white;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <p style="font-weight: 700; font-size: 1.1rem; color: #333; margin-bottom: 5px;" th:text="${coupon.couponName}">ì¿ í°ëª…</p>
                                        <p style="font-size: 0.9rem; color: #666;" th:text="${coupon.description}">ì„¤ëª…</p>
                                    </div>
                                    <div><span style="font-size: 1.5rem; font-weight: 700; color: #E1545A;">+<span th:text="${coupon.rateIncrease}">5</span>%</span></div>
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 20px; padding: 20px; background: #FAE5E6; border-radius: 8px; text-align: center;">
                            <p style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">í¬ì¸íŠ¸ + ì¿ í° ì ìš© ìµœì¢… ê¸ˆë¦¬</p>
                            <p style="font-size: 2.2rem; font-weight: 700; color: var(--red-900);" id="totalFinalRate">ì—° 2.50%</p>
                            <p style="font-size: 0.85rem; color: #666; margin-top: 5px;">(ê¸°ë³¸ <span id="baseRateDisplay2" th:text="${joinRequest.baseRate} + '%'">2.50%</span> + í¬ì¸íŠ¸ <span id="pointRateDisplay2">0.00%</span> + ì¿ í° <span id="couponRateDisplay2">0.00%</span>)</p>
                        </div>
                    </div>
                    <input type="hidden" name="selectedCouponId" id="selectedCouponId" value="">
                    <input type="hidden" name="couponBonusRate" id="couponBonusRate" value="0">
                </div>
            </div>

            <!-- 2. ê¸ˆë¦¬ ê³„ì‚°ê¸° ì„¹ì…˜ ì¶”ê°€ -->
            <h3 class="section-title">ğŸ’° ê¸ˆë¦¬ ê³„ì‚°ê¸°</h3>
            <div class="calculator-box" style="border: 2px solid var(--grey-300); border-radius: 12px; padding: 30px; background: var(--grey-100); margin-bottom: 30px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 8px;">ê°€ì… ê¸ˆì•¡ (ì›)</label>
                        <input type="number"
                               id="calcAmount"
                               th:value="${joinRequest.principalAmount}"
                               style="width: 100%; padding: 12px; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 1rem;">
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 8px;">ê°€ì… ê¸°ê°„ (ê°œì›”)</label>
                        <input type="number"
                               id="calcTerm"
                               th:value="${joinRequest.contractTerm}"
                               style="width: 100%; padding: 12px; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 1rem;">
                    </div>
                </div>

                <button type="button"
                        onclick="calculateInterest()"
                        style="width: 100%; padding: 15px; background: var(--red-900); color: white; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 700; cursor: pointer; margin-bottom: 20px;">
                    ê¸ˆë¦¬ ê³„ì‚°í•˜ê¸°
                </button>

                <div id="calcResult" style="background: white; border-radius: 8px; padding: 20px; display: none;">
                    <div style="display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid var(--grey-300);">
                        <span style="color: var(--grey-700);">ì ìš© ê¸ˆë¦¬</span>
                        <span style="font-weight: 700; font-size: 1.1rem;" id="calcApplyRate">-</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid var(--grey-300);">
                        <span style="color: var(--grey-700);">ì˜ˆìƒ ì„¸ì „ ì´ì</span>
                        <span style="font-weight: 700; font-size: 1.1rem; color: var(--red-900);" id="calcInterest">-</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 15px 0; background: var(--grey-100); margin: 15px -20px -20px; padding: 20px; border-radius: 0 0 8px 8px;">
                        <span style="font-weight: 700;">ë§Œê¸° ìˆ˜ë ¹ì•¡</span>
                        <span style="font-weight: 700; font-size: 1.3rem; color: var(--red-900);" id="calcTotal">-</span>
                    </div>
                </div>
            </div>



            <h3 class="section-title">ì¶©ë¶„íˆ ì´í•´í•˜ì…¨ë‚˜ìš”?</h3>
            <div class="check-group">
                <div class="check-item" data-check="check1">
                        <span class="check-item-label">
                            ë§Œê¸°ì¼ ì „ì— ì¤‘ë„í•´ì§€í•˜ë©´ ì•½ì • ì´ììœ¨ì´ ì•„ë‹Œ <br/>
                            **ì¤‘ë„í•´ì§€ ì´ììœ¨ì´ ì ìš©ë¨**ì„ ì´í•´í•˜ì…¨ë‚˜ìš”?
                        </span>
                    <div class="check-item-action toggle-group">
                        <button type="button" class="toggle-btn" data-value="Y">ì˜ˆ</button>
                        <button type="button" class="toggle-btn" data-value="N">ì•„ë‹ˆìš”</button>
                    </div>
                </div>

                <div class="check-item" data-check="check2">
                        <span class="check-item-label">
                            ìµœì¢… ì ìš© ì´ììœ¨ì€ ë§Œê¸° ì‹œì ì— í™•ì •ëœ <br/>
                            **ìš°ëŒ€ì´ììœ¨ì— ë”°ë¼ ë‹¬ë¼ì§**ì„ ì´í•´í•˜ì…¨ë‚˜ìš”?
                        </span>
                    <div class="check-item-action toggle-group">
                        <button type="button" class="toggle-btn" data-value="Y">ì˜ˆ</button>
                        <button type="button" class="toggle-btn" data-value="N">ì•„ë‹ˆìš”</button>
                    </div>
                </div>
            </div>

            <h3 class="section-title">ì˜ˆê¸ˆìƒí’ˆê³„ì•½ì„œ ì „ìì„œëª…</h3>
            <div class="sign-area">
                <button type="button" id="signButton" class="sign-button" data-modal-target="signatureModal">
                    ì „ìì„œëª… ëŒ€ì‹ , ê³„ì•½ì„œ í™•ì¸í•˜ê³  ê°€ì…í•˜ê¸°
                </button>
                <p id="signStatus" class="sign-info">
                    **[í•„ìˆ˜]** ìœ„ ë²„íŠ¼ì„ ëˆŒëŸ¬ ê³„ì•½ì„œ ë‚´ìš©ì„ í™•ì¸í•˜ê³  ë™ì˜í•´ì£¼ì„¸ìš”.
                </p>
            </div>


            <div class="button-area">
                <button type="button" class="btn-prev" onclick="history.back()">ì´ì „ (STEP 2ë¡œ)</button>
                <button id="btnNext" class="btn-next" type="submit">ë‹¤ìŒ (STEP 4ë¡œ)</button>
            </div>
        </form>
    </div>
</section>

<div id="signatureModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>ì „ìì„œëª… ëŒ€ì‹ , ì•„ë˜ ë‚´ìš©ì„ í™•ì¸í•˜ê³ </h2>
            <span class="close-btn" data-modal-close="signatureModal">&times;</span>
        </div>

        <div class="modal-body">
            <div class="contract-preview">
                <div class="contract-header" style="text-align: center; margin-bottom: 15px;">
                    <h3 style="font-size: 1.1rem; font-weight: 700; color: var(--grey-900); margin-bottom: 5px;">[ì˜ˆê¸ˆìƒí’ˆ ê³„ì•½ì„œ]</h3>
                    <span style="font-size: 0.9rem; color: var(--grey-500);">ì‹ í•œì€í–‰ ì¤€ë²•ê°ì‹œì¸ ì‚¬ì „ì‹¬ì‚¬í•„ ì œ2022-4</span>
                </div>

                <table style="width: 100%; border-collapse: collapse; font-size: 0.95rem; margin-bottom: 20px;">
                    <tbody style="border: 1px solid var(--grey-300);">
                    <tr>
                        <th style="width: 25%; background-color: #f0f0f0; border: 1px solid var(--grey-300); padding: 8px 10px; text-align: center; color: var(--grey-700); font-weight: 500;">ìƒí’ˆëª… (ì—…ì²´ëª…)</th>
                        <td colspan="3" style="width: 75%; border: 1px solid var(--grey-300); padding: 8px 10px; text-align: center; color: var(--grey-900);">ì‹ í•œ Myí”ŒëŸ¬ìŠ¤ ì •ê¸°ì˜ˆê¸ˆ (ì‹ í•œì€í–‰)</td>
                    </tr>
                    <tr>
                        <th style="width: 25%; background-color: #f0f0f0; border: 1px solid var(--grey-300); padding: 8px 10px; text-align: center; color: var(--grey-700); font-weight: 500;">ì‹ ê·œ ê¸ˆì•¡</th>
                        <td style="width: 25%; border: 1px solid var(--grey-300); padding: 8px 10px; text-align: center; color: var(--grey-900);" id="contractAmount">500,000ì›</td>
                        <th style="width: 25%; background-color: #f0f0f0; border: 1px solid var(--grey-300); padding: 8px 10px; text-align: center; color: var(--grey-700); font-weight: 500;">ê³„ì•½ ê¸°ê°„</th>
                        <td style="width: 25%; border: 1px solid var(--grey-300); padding: 8px 10px; text-align: center; color: var(--grey-900);" id="contractTerm">1ê°œì›”</td>
                        <!-- <td id="displayTerm"
                            th:text="${joinRequest.contractTerm} + 'ê°œì›” (' + ${joinRequest.expectedEndDate} + ' ë§Œê¸°)'">
                               </td> ì´ë ‡ê²Œ ë°”ê¿”ì•¼ í•œë‹¤ê³ ëŠ” í•¨. -->
                    </tr>
                    <tr>
                        <th style="width: 25%; background-color: #f0f0f0; border: 1px solid var(--grey-300); padding: 8px 10px; text-align: center; color: var(--grey-700); font-weight: 500;">ìë™ ì´ì²´ ê³„ì¢Œ</th>
                        <td style="width: 25%; border: 1px solid var(--grey-300); padding: 8px 10px; text-align: center; color: var(--grey-900);">-</td>
                        <th style="width: 25%; background-color: #f0f0f0; border: 1px solid var(--grey-300); padding: 8px 10px; text-align: center; color: var(--grey-700); font-weight: 500;">ì´ì ì£¼ê¸° ë° ë‚©ì…ì¼</th>
                        <td style="width: 25%; border: 1px solid var(--grey-300); padding: 8px 10px; text-align: center; color: var(--grey-900);">-</td>
                    </tr>
                    <tr>
                        <th style="width: 25%; background-color: #f0f0f0; border: 1px solid var(--grey-300); padding: 8px 10px; text-align: center; color: var(--grey-700); font-weight: 500;">ìµœì´ˆ ì‹ ê·œ ì ìš© ì´ìœ¨</th>
                        <td style="width: 25%; border: 1px solid var(--grey-300); padding: 8px 10px; text-align: center; color: var(--grey-900);">ì—° 2.35%</td>
                        <th style="width: 25%; background-color: #f0f0f0; border: 1px solid var(--grey-300); padding: 8px 10px; text-align: center; color: var(--grey-700); font-weight: 500;">ì´ì ì§€ê¸‰ ë°©ì‹</th>
                        <td style="width: 25%; border: 1px solid var(--grey-300); padding: 8px 10px; text-align: center; color: var(--grey-900);">ë§Œê¸°ì¼ì‹œì§€ê¸‰ ë‹¨ë¦¬ì‹</td>
                    </tr>
                    <tr>
                        <th style="width: 25%; background-color: #f0f0f0; border: 1px solid var(--grey-300); padding: 8px 10px; text-align: center; color: var(--grey-700); font-weight: 500;">ê³¼ì„¸ êµ¬ë¶„</th>
                        <td style="width: 25%; border: 1px solid var(--grey-300); padding: 8px 10px; text-align: center; color: var(--grey-900);" id="contractTaxType">ì¼ë°˜ê³¼ì„¸</td>
                        <th style="width: 25%; background-color: #f0f0f0; border: 1px solid var(--grey-300); padding: 8px 10px; text-align: center; color: var(--grey-700); font-weight: 500;">ìœ ì˜ì‚¬í•­</th>
                        <td style="width: 25%; border: 1px solid var(--grey-300); padding: 8px 10px; text-align: center; color: var(--grey-900);">ìœ </td>
                    </tr>
                    <tr>
                        <th style="width: 25%; background-color: #f0f0f0; border: 1px solid var(--grey-300); padding: 8px 10px; text-align: center; color: var(--grey-700); font-weight: 500;">ê³„ì•½ ì²´ê²°ì¼</th>
                        <td style="width: 25%; border: 1px solid var(--grey-300); padding: 8px 10px; text-align: center; color: var(--grey-900);">2025.11.10</td>
                        <th style="width: 25%; background-color: #f0f0f0; border: 1px solid var(--grey-300); padding: 8px 10px; text-align: center; color: var(--grey-700); font-weight: 500;">ì—°ê²° ê³„ì¢Œ (ìë™í•´ì§€ ì‹œ)</th>
                        <td style="width: 25%; border: 1px solid var(--grey-300); padding: 8px 10px; text-align: center; color: var(--grey-900);">110-123-123456</td>
                    </tr>
                    </tbody>
                </table>

                <div class="contract-section">
                    <h4 style="font-size: 1rem; font-weight: 700; color: var(--grey-900); margin-top: 15px; margin-bottom: 10px;">â–  ì˜ˆê¸ˆìƒí’ˆ ê³„ì•½ ì²´ê²°ì— ê´€í•œ ì‚¬í•­</h4>
                    <p style="font-size: 0.9rem; color: var(--grey-700); line-height: 1.6; margin-bottom: 15px;">â€» ì¶©ë¶„í•œ ì´í•´ ì—†ì´ ë‹µë³€í•˜ëŠ” ê²½ìš° ì¶”í›„ ì†Œì†¡ì´ë‚˜ ë¶„ìŸ ë°œìƒ ì‹œ ë³¸ì¸ì—ê²Œ ë¶ˆë¦¬í•˜ê²Œ ì‘ìš©í•  ìˆ˜ ìˆìœ¼ë‹ˆ ì§ˆë¬¸ì— ë‹µí•´ ì£¼ì‹­ì‹œì˜¤.</p>

                    <!-- âœ… ì²´í¬ë°•ìŠ¤ë¡œ ë³€ê²½ -->
                    <div style="border: 1px solid var(--grey-300); padding: 15px; margin-bottom: 15px;">
                        <p style="margin-bottom: 10px; font-weight: 600;">ë³¸ì¸ì€ ìœ„ ì˜ˆê¸ˆìƒí’ˆì˜ ì¤‘ìš”í•œ ì‚¬í•­ì„ ì¶©ë¶„íˆ ì„¤ëª…ë°›ê³  ì´í•´í•˜ì˜€ìŠµë‹ˆê¹Œ?</p>
                        <div class="contract-checkbox-wrapper">
                            <div class="contract-checkbox-item">
                                <input type="checkbox" id="contractUnderstandYes" name="contractUnderstand" value="yes">
                                <label for="contractUnderstandYes">ì˜ˆ</label>
                            </div>
                            <div class="contract-checkbox-item">
                                <input type="checkbox" id="contractUnderstandNo" name="contractUnderstand" value="no">
                                <label for="contractUnderstandNo">ì•„ë‹ˆìš”</label>
                            </div>
                        </div>
                    </div>

                    <h4 style="font-size: 1rem; font-weight: 700; color: var(--grey-900); margin-top: 15px; margin-bottom: 10px;">â–  ì˜ˆê¸ˆìƒí’ˆì˜ ì¤‘ìš”í•œ ì‚¬í•­ì´ í¬í•¨ëœ ì˜ˆê¸ˆìƒí’ˆì˜ ì¤‘ìš” ë‚´ìš© ìš”ì•½</h4>
                    <ul style="list-style: disc; margin-left: 20px; font-size: 0.9rem; color: var(--grey-700); line-height: 1.6; margin-bottom: 15px;">
                        <li>ìƒí’ˆì˜ ê°œìš” (ê³„ì•½ ê¸°ê°„, ì´ìì˜ ì§€ê¸‰ ì‹œê¸° ë° ì§€ê¸‰ ë°©ì‹ ë“±)</li>
                        <li>ì´ììœ¨ ë° ì´ì ê³„ì‚° ë°©ë²•, ì¤‘ë„í•´ì§€ ì´ììœ¨ ë° ë§Œê¸° ì´ìœ¨, ì´ììœ¨ ë³€ê²½ì— ê´€í•œ ì‚¬í•­</li>
                        <li>ê³„ì•½ì´ í•´ì§€(ì˜ˆì™¸ì ìœ¼ë¡œ í•´ì§€)ë˜ê±°ë‚˜, í•´ì§€ì´ìœ¨, ì˜ˆê¸ˆì ë³´í˜¸ ì—¬ë¶€ ë° ê·¸ ë‚´ìš©</li>
                        <li>ì†ì‹¤ ë°œìƒ ìœ„í—˜, ë¯¼ì› ì²˜ë¦¬ ë° ë¶„ìŸ ì¡°ì •, ê¸ˆìœµì†Œë¹„ì ê¶Œë¦¬ ì¹¨í•´ ì‹œ êµ¬ì œ ë°©ë²•</li>
                    </ul>
                    <textarea readonly style="width: 100%; height: 100px; border: 1px solid var(--grey-300); padding: 10px; margin-top: 10px; background-color: var(--white); resize: none; font-size: 0.9rem; color: var(--grey-900); line-height: 1.4;">
ì´ ì˜ˆê¸ˆ ìƒí’ˆ ê³„ì•½ì„œì— ëª…ì‹œëœ ëª¨ë“  ë‚´ìš©ì„ ì¶©ë¶„íˆ ì½ê³  ì´í•´í•˜ì˜€ìœ¼ë©°, ì´ ê³„ì•½ì— ë™ì˜í•©ë‹ˆë‹¤.
2025ë…„ 11ì›” 10ì¼
ì„±ëª…(ë²•ì¸ ëŒ€í‘œ): ê¹€ìˆ˜ì§„
(ì¸)
                    </textarea>

                    <div class="sign-area" style="text-align: right; padding-top: 15px;">
                        <span style="font-size: 0.9rem; color: var(--grey-700);">**ì „ìì„œëª… ëŒ€ì‹ , ìœ„ ë‚´ìš©ì„ í™•ì¸í•˜ê³  ê°€ì…ì„ ì§„í–‰í•©ë‹ˆë‹¤.**</span><br>
                        <span style="font-size: 0.95rem; color: var(--grey-900); font-weight: 700;">**2025ë…„ 11ì›” 10ì¼ (ì „ì)ê¹€ìˆ˜ì§„ (ë²•ì •)ëŒ€ë¦¬ì¸**</span>
                    </div>
                </div>
            </div>

            <p class="confirm-question">
                ìœ„ **[ì˜ˆê¸ˆìƒí’ˆê³„ì•½ì„œ]** ë‚´ìš©ì„ ëª¨ë‘ í™•ì¸í•˜ê³ ,<br>
                ìƒí’ˆê°€ì…ê³¼ ê´€ë ¨ëœ ê³„ì•½ì •ë³´ë¥¼ **ëª¨ë‘ í™•ì¸í•˜ê³  ì´í•´í–ˆìŒì„ ë™ì˜**í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
            </p>

            <div class="check-item-action toggle-group" id="modalAgreement" style="justify-content: center; margin-bottom: 20px;">
                <button type="button" class="toggle-btn" data-modal-value="Y">ì˜ˆ, ë™ì˜í•©ë‹ˆë‹¤.</button>
                <button type="button" class="toggle-btn" data-modal-value="N">ì•„ë‹ˆìš”</button>
            </div>

        </div>
        <div class="modal-footer">
            <button type="button" class="btn-secondary" data-modal-close="signatureModal">ì·¨ì†Œ</button>
            <button type="button" class="btn-pdf" id="contractPdfBtn">PDFë¡œ ë³´ê¸°</button>
            <button type="button" class="btn-primary" id="confirmSignatureBtn" disabled>ë‹¤ìŒ ë‹¨ê³„ë¡œ</button>
        </div>
    </div>
</div>


<!-- Footer ë¶€ë¶„ -->
<div th:replace="~{_footer :: footerFragment(${appInfo})}"></div>

<script>
    window.BASE_URL = /*[[@{/}]]*/ "/busanbank/";

    // ========================================
    // 1. Thymeleaf ë³€ìˆ˜ ì„ ì–¸
    // ========================================
    const totalUserPoints = /*[[${userPoints}]]*/ 0;
    const baseRate = parseFloat(/*[[${baseRate}]]*/ '2.50');
    const initialPointBonus = parseFloat(/*[[${joinRequest.pointBonusRate}]]*/ '0.00');
    const principalAmount = parseInt(/*[[${joinRequest.principalAmount}]]*/ '1000000');
    const contractTerm = parseInt(/*[[${joinRequest.contractTerm}]]*/ '12');
    const productType = /*[[${joinRequest.productType}]]*/ '01';

    // ========================================
    // 2. í¬ì¸íŠ¸ ì„ íƒ ë¡œì§
    // ========================================
    let selectedPointsValue = 0;
    let selectedCouponIdValue = null;
    let selectedCouponRateValue = 0;

    document.addEventListener('DOMContentLoaded', function() {
        const pointSlider = document.getElementById('pointSlider');
        if (pointSlider) {
            pointSlider.value = 0;
            pointSlider.addEventListener('input', function(e) {
                selectedPointsValue = parseInt(e.target.value) || 0;
                updatePointDisplay();
            });
            updatePointDisplay();
        }
    });

    function selectPoints(points) {
        const maxPoints = totalUserPoints;
        selectedPointsValue = Math.min(points, maxPoints);
        const slider = document.getElementById('pointSlider');
        if (slider) {
            slider.value = selectedPointsValue;  // âœ… ì´ ì¤„ì´ í•µì‹¬!
        }
        updatePointDisplay();  // âœ… slider.value ì—…ë°ì´íŠ¸ í›„ ì‹¤í–‰
    }

    function selectPointsMax() {
        selectedPointsValue = totalUserPoints;
        const slider = document.getElementById('pointSlider');
        if (slider) {
            slider.value = selectedPointsValue;  // âœ… ì´ ì¤„ì´ í•µì‹¬!
        }
        updatePointDisplay();  // âœ… slider.value ì—…ë°ì´íŠ¸ í›„ ì‹¤í–‰
    }

    function updatePointDisplay() {
        const bonusRate = (selectedPointsValue / 100) * 0.1;
        const finalApplyRate = baseRate + bonusRate;

        const updateElement = (id, value) => {
            const elem = document.getElementById(id);
            if (elem) {
                if (elem.tagName === 'INPUT') {
                    elem.value = value;
                } else {
                    elem.textContent = value;
                }
            }
        };

        updateElement('selectedPoints', selectedPointsValue.toLocaleString());
        updateElement('pointBonusRate', bonusRate.toFixed(2));
        updateElement('bonusRateDisplay', bonusRate.toFixed(2) + '%');
        updateElement('finalRate', 'ì—° ' + finalApplyRate.toFixed(2) + '%');
        updateElement('currentApplyRate', 'ì—° ' + finalApplyRate.toFixed(2) + '%');

        // âœ… ì´ 3ì¤„ì„ ì¶”ê°€!
        updateElement('displayPointBonus', '+ ' + bonusRate.toFixed(2) + '%');
        updateElement('displayFinalRate', 'ì—° ' + finalApplyRate.toFixed(2) + '%');
        updateElement('displayPointBonusSmall', bonusRate.toFixed(2) + '%');

        updateElement('usedPoints', selectedPointsValue);
        updateElement('pointBonusRateInput', bonusRate.toFixed(2));
        updateElement('applyRateInput', finalApplyRate.toFixed(2));
        updateAllRates();

    }

    // ========================================
    // 3. ê¸ˆë¦¬ ê³„ì‚°ê¸°
    // ========================================

    function selectCoupon(couponId, rateIncrease) {
        selectedCouponIdValue = couponId;
        selectedCouponRateValue = parseFloat(rateIncrease) || 0;
        document.getElementById('selectedCouponId').value = couponId || '';
        document.getElementById('couponBonusRate').value = selectedCouponRateValue;
        document.querySelectorAll('.coupon-card').forEach(card => {
            card.style.border = '2px solid #ddd';
            card.style.background = 'white';
        });
        if (event && event.currentTarget) {
            event.currentTarget.style.border = '2px solid #E1545A';
            event.currentTarget.style.background = 'linear-gradient(135deg, #FAE5E6 0%, #FFF0F0 100%)';
        }
        updateAllRates();
    }

    function updateAllRates() {
        const pointBonus = (selectedPointsValue / 100) * 0.1;
        const couponBonus = selectedCouponRateValue;
        const finalRate = baseRate + pointBonus + couponBonus;
        const updateElement = (id, value) => {
            const elem = document.getElementById(id);
            if (elem) {
                if (elem.tagName === 'INPUT') elem.value = value;
                else elem.textContent = value;
            }
        };
        updateElement('finalRate', 'ì—° ' + finalRate.toFixed(2) + '%');
        updateElement('currentApplyRate', 'ì—° ' + finalRate.toFixed(2) + '%');
        updateElement('displayFinalRate', 'ì—° ' + finalRate.toFixed(2) + '%');
        updateElement('totalFinalRate', 'ì—° ' + finalRate.toFixed(2) + '%');
        updateElement('pointRateDisplay2', pointBonus.toFixed(2) + '%');
        updateElement('couponRateDisplay2', couponBonus.toFixed(2) + '%');
        updateElement('applyRateInput', finalRate.toFixed(2));
    }

    function calculateInterest() {
        const amount = parseInt(document.getElementById('calcAmount').value) || 0;
        const term = parseInt(document.getElementById('calcTerm').value) || 0;

        if (amount <= 0 || term <= 0) {
            alert('ê°€ì… ê¸ˆì•¡ê³¼ ê¸°ê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        const applyRate = parseFloat(document.getElementById('applyRateInput').value) || baseRate;

        let interest = 0;
        if (productType === '01') {
            interest = amount * (applyRate / 100) * (term / 12);
        } else if (productType === '02') {
            const totalDeposits = amount * term;
            interest = totalDeposits * (term + 1) / 24 * (applyRate / 100);
        }

        const total = amount + Math.round(interest);

        if (document.getElementById('calcApplyRate')) {
            document.getElementById('calcApplyRate').textContent = 'ì—° ' + applyRate.toFixed(2) + '%';
        }
        if (document.getElementById('calcInterest')) {
            document.getElementById('calcInterest').textContent = Math.round(interest).toLocaleString() + 'ì›';
        }
        if (document.getElementById('calcTotal')) {
            document.getElementById('calcTotal').textContent = total.toLocaleString() + 'ì›';
        }
        if (document.getElementById('calcResult')) {
            document.getElementById('calcResult').style.display = 'block';
        }
    }

    // ========================================
    // 4. SessionStorage ë°ì´í„° ì²˜ë¦¬
    // ========================================
    const userData = {
        amount: sessionStorage.getItem('amount') || principalAmount.toString(),
        term: sessionStorage.getItem('term') || contractTerm.toString(),
        taxType: sessionStorage.getItem('taxType') || 'general'
    };

    window.addEventListener('load', function() {
        const amount = parseInt(userData.amount);
        if (document.getElementById('displayAmount')) {
            document.getElementById('displayAmount').textContent = amount.toLocaleString() + 'ì›';
        }
        if (document.getElementById('contractAmount')) {
            document.getElementById('contractAmount').textContent = amount.toLocaleString() + 'ì›';
        }

        const term = parseInt(userData.term);
        const today = new Date();
        const maturityDate = new Date(today.setMonth(today.getMonth() + term));
        const maturityStr = maturityDate.getFullYear() + '.' +
            String(maturityDate.getMonth() + 1).padStart(2, '0') + '.' +
            String(maturityDate.getDate()).padStart(2, '0');

        if (document.getElementById('displayTerm')) {
            document.getElementById('displayTerm').textContent = term + 'ê°œì›” (' + maturityStr + ' ë§Œê¸°)';
        }
        if (document.getElementById('contractTerm')) {
            document.getElementById('contractTerm').textContent = term + 'ê°œì›”';
        }

        const taxTypeText = userData.taxType === 'general' ? 'ì¼ë°˜ê³¼ì„¸' : 'ë¹„ê³¼ì„¸ì¢…í•©';
        if (document.getElementById('displayTaxType')) {
            document.getElementById('displayTaxType').textContent = taxTypeText;
        }
        if (document.getElementById('contractTaxType')) {
            document.getElementById('contractTaxType').textContent = taxTypeText;
        }
    });

    // ========================================
    // 5. STEP 3 ë™ì˜ ìƒíƒœ ê´€ë¦¬
    // ========================================
    const requirements = {
        check1: false,
        check2: false,
        contractUnderstand: false,
        signed: false
    };

    const form = document.getElementById('reviewForm');
    const btnNext = document.getElementById('btnNext');
    const signStatus = document.getElementById('signStatus');
    const signatureModal = document.getElementById('signatureModal');
    const modalAgreementGroup = document.getElementById('modalAgreement');
    const confirmSignatureBtn = document.getElementById('confirmSignatureBtn');
    const contractYes = document.getElementById('contractUnderstandYes');
    const contractNo = document.getElementById('contractUnderstandNo');

    function checkAllRequirements() {
        const allChecked = requirements.check1 && requirements.check2 && requirements.signed;
        if (btnNext) {
            btnNext.disabled = !allChecked;
        }
    }

    function checkContractUnderstanding() {
        if (contractYes) {
            requirements.contractUnderstand = contractYes.checked;
        }

        if (!requirements.contractUnderstand && modalAgreementGroup) {
            modalAgreementGroup.querySelectorAll('.toggle-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            if (confirmSignatureBtn) {
                confirmSignatureBtn.disabled = true;
            }
        }
    }

    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'none';
            document.body.style.overflow = '';
        }
    }

    // ì´í•´ í™•ì¸ í† ê¸€ ë²„íŠ¼
    document.querySelectorAll('.check-group .toggle-group').forEach(group => {
        group.addEventListener('click', (e) => {
            const target = e.target;
            if (target.tagName === 'BUTTON') {
                group.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('selected'));
                target.classList.add('selected');

                const checkItem = group.closest('.check-item');
                if (checkItem) {
                    const checkKey = checkItem.getAttribute('data-check');
                    requirements[checkKey] = (target.dataset.value === 'Y');
                }

                checkAllRequirements();
            }
        });
    });

    // ì „ìì„œëª… ë²„íŠ¼
    const signButton = document.getElementById('signButton');
    if (signButton) {
        signButton.addEventListener('click', (e) => {
            e.preventDefault();
            if (signatureModal) {
                signatureModal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }

            if (confirmSignatureBtn) {
                confirmSignatureBtn.disabled = true;
            }
            if (modalAgreementGroup) {
                modalAgreementGroup.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('selected'));
            }

            if (contractYes) contractYes.checked = false;
            if (contractNo) contractNo.checked = false;
            requirements.contractUnderstand = false;
        });
    }

    // ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸
    if (contractYes) {
        contractYes.addEventListener('change', function() {
            if (this.checked && contractNo) {
                contractNo.checked = false;
            }
            checkContractUnderstanding();
        });
    }

    if (contractNo) {
        contractNo.addEventListener('change', function() {
            if (this.checked) {
                if (contractYes) contractYes.checked = false;
                requirements.contractUnderstand = false;
                if (modalAgreementGroup) {
                    modalAgreementGroup.querySelectorAll('.toggle-btn').forEach(btn => {
                        btn.classList.remove('selected');
                    });
                }
                if (confirmSignatureBtn) {
                    confirmSignatureBtn.disabled = true;
                }
            }
        });
    }

    // ëª¨ë‹¬ ë™ì˜ ë²„íŠ¼
    if (modalAgreementGroup) {
        modalAgreementGroup.addEventListener('click', (e) => {
            const target = e.target;
            if (target.tagName === 'BUTTON') {
                if (!requirements.contractUnderstand) {
                    alert('ê³„ì•½ì„œ ë‚´ìš©ì„ ì¶©ë¶„íˆ ì´í•´í•˜ì˜€ëŠ”ì§€ ë¨¼ì € í™•ì¸í•´ì£¼ì„¸ìš”.');
                    return;
                }

                modalAgreementGroup.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('selected'));
                target.classList.add('selected');

                const isAgreed = (target.dataset.modalValue === 'Y');
                if (confirmSignatureBtn) {
                    confirmSignatureBtn.disabled = !isAgreed;
                }
            }
        });
    }

    // ì„œëª… ì™„ë£Œ ë²„íŠ¼
    if (confirmSignatureBtn) {
        confirmSignatureBtn.addEventListener('click', () => {
            requirements.signed = true;
            if (signStatus) {
                signStatus.innerHTML = '<strong style="color: var(--red-900);">[ì™„ë£Œ]</strong> ê³„ì•½ ë‚´ìš©ì„ í™•ì¸í•˜ê³  ê°€ì…ì— ë™ì˜í–ˆìŠµë‹ˆë‹¤.';
            }
            closeModal('signatureModal');
            checkAllRequirements();
        });
    }

    // ëª¨ë‹¬ ë‹«ê¸°
    document.querySelectorAll('[data-modal-close]').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const modalId = e.target.getAttribute('data-modal-close');
            closeModal(modalId);
        });
    });

    window.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) {
            closeModal(e.target.id);
        }
    });

    // í¼ ì œì¶œ
    // âœ… ìˆ˜ì •:
    if (form) {
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            if (btnNext && !btnNext.disabled) {
                // âœ… ì œì¶œ ì§ì „ ê°•ì œ ì—…ë°ì´íŠ¸!
                const bonusRate = (selectedPointsValue / 100) * 0.1;
                const finalApplyRate = baseRate + bonusRate;

                document.getElementById('usedPoints').value = selectedPointsValue;
                document.getElementById('pointBonusRateInput').value = bonusRate.toFixed(2);
                document.getElementById('applyRateInput').value = finalApplyRate.toFixed(2);

                alert("ì…ë ¥ ì •ë³´ í™•ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. STEP 4 ìµœì¢… í™•ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
                form.submit();
            }
        });
    }

    // PDF ë³´ê¸° ë²„íŠ¼
    const contractPdfBtn = document.getElementById('contractPdfBtn');
    if (contractPdfBtn) {
        contractPdfBtn.addEventListener('click', () => {
            const modalBody = document.querySelector('#signatureModal .modal-body');
            const contractContent = modalBody.innerHTML;

            const width = 1000;
            const height = 800;
            const left = (screen.width - width) / 2;
            const top = (screen.height - height) / 2;
            const printWindow = window.open('', '_blank', `width=${width},height=${height},left=${left},top=${top}`);

            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="ko">
                <head>
                    <meta charset="UTF-8">
                    <title>ì˜ˆê¸ˆìƒí’ˆ ê³„ì•½ì„œ - BNKë¶€ì‚°ì€í–‰</title>
                    <style>
                        :root {
                            --red-900: #D03238;
                            --grey-900: #333333;
                            --grey-700: #666666;
                            --grey-500: #B9B9B9;
                            --grey-300: #DEDEDE;
                            --grey-100: #F8F8F8;
                            --white: #ffffff;
                        }
                        * { box-sizing: border-box; margin: 0; padding: 0; }
                        body {
                            font-family: 'Noto Sans KR', sans-serif;
                            color: var(--grey-900);
                            padding: 40px;
                            background-color: var(--white);
                            line-height: 1.6;
                        }
                        h2, h3, h4 { color: var(--grey-900); margin-bottom: 15px; }
                        h2 { font-size: 1.8rem; text-align: center; margin-bottom: 30px; }
                        h3 { font-size: 1.3rem; }
                        h4 { font-size: 1.1rem; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                        th, td { border: 1px solid var(--grey-300); padding: 10px; text-align: center; }
                        th { background-color: var(--grey-100); font-weight: 600; }
                        ul { margin-left: 20px; margin-bottom: 15px; }
                        li { margin-bottom: 5px; }
                        .contract-checkbox-wrapper { display: flex; gap: 20px; margin-top: 10px; }
                        .contract-checkbox-item { display: flex; align-items: center; gap: 8px; }
                        @media print {
                            body { padding: 20px; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <h2>ì˜ˆê¸ˆìƒí’ˆ ê³„ì•½ì„œ</h2>
                    ${contractContent}
                    <div style="margin-top: 30px; text-align: center;" class="no-print">
                        <button onclick="window.print()" style="padding: 10px 30px; background-color: var(--red-900); color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem;">ì¸ì‡„í•˜ê¸°</button>
                        <button onclick="window.close()" style="padding: 10px 30px; background-color: var(--grey-500); color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem; margin-left: 10px;">ë‹«ê¸°</button>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
        });
    }

    // ì´ˆê¸° ìƒíƒœ í™•ì¸
    checkAllRequirements();
</script>
</body>
</html>